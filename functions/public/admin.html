<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - 3E Elite Status</title>
    <link id="adminFavicon" rel="icon" href="/assets/brand/Elite-Logo-01.png" type="image/png">
    <link id="adminAppleIcon" rel="apple-touch-icon" href="/assets/brand/Elite-Logo-01.png">
    <meta property="og:title" content="3E Elite Status Admin">
    <meta property="og:description" content="Manage status, incidents, and uptime.">
    <meta id="adminOgImage" property="og:image" content="/assets/brand/Elite-Logo-01.png">
    <meta name="twitter:card" content="summary">
    <meta id="adminTwitterImage" name="twitter:image" content="/assets/brand/Elite-Logo-01.png">
    <link rel="stylesheet" href="/theme.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--surface);color:var(--text-primary);line-height:1.6}
        a{color:var(--brand-primary);text-decoration:none}

        /* Layout */
        .app{display:flex;min-height:100vh}
        .sidebar{width:240px;background:var(--brand-deep-purple);color:#fff;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:50}
        .sidebar-brand{padding:20px;font-size:16px;font-weight:600;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:10px}
        .sidebar-brand img{background:#fff;padding:4px;border-radius:6px}
        .sidebar-brand svg{flex-shrink:0}
        .sidebar-nav{flex:1;padding:12px 0;overflow-y:auto}
        .nav-section{padding:0 12px;margin-bottom:8px}
        .nav-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);padding:8px 12px;font-weight:600}
        .nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:4px;color:rgba(255,255,255,.75);font-size:13px;cursor:pointer;transition:all .15s;margin-bottom:2px}
        .nav-item:hover{background:rgba(255,255,255,.12);color:#fff}
        .nav-item.active{background:rgba(255,255,255,.18);color:#fff;font-weight:600}
        .nav-item .icon{width:18px;text-align:center;font-size:14px}
        .sidebar-tools{padding:12px;border-bottom:1px solid rgba(255,255,255,.1)}
        .sidebar-tools .project-select{width:100%;padding:9px 12px;border:1px solid rgba(255,255,255,.2);border-radius:4px;background:rgba(255,255,255,.08);color:#fff;font-size:13px}
        .sidebar-tools .project-select option{color:#000}
        .sidebar-tools .nav-item{margin-bottom:8px}
        .sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.1)}
        .user-badge{display:flex;align-items:center;gap:10px;padding:8px;border-radius:4px;cursor:pointer;transition:background .15s}
        .user-badge:hover{background:rgba(255,255,255,.1)}
        .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--brand-primary);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
        .user-meta{flex:1}
        .user-meta .name{font-size:13px;font-weight:500}
        .user-meta .role{font-size:11px;color:rgba(255,255,255,.5)}

        /* Main */
        .main{flex:1;margin-left:240px}
        .topbar{background:#fff;border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:40}
        .topbar-title{font-size:20px;font-weight:600}
        .topbar-actions{display:flex;gap:10px;align-items:center}
        .project-select{padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;background:#fff}
        .content{padding:24px}

        /* Cards */
        .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:20px;box-shadow:var(--shadow-card)}
        .tree-node{border-bottom:1px solid #f4f5f7;padding:10px 0}
        .tree-row{display:flex;align-items:center;gap:10px}
        .tree-row[draggable="true"]{cursor:grab}
        .tree-row.dragging{opacity:.5}
        .tree-row.drag-over{outline:1px dashed rgba(135,56,255,.45);outline-offset:2px}
        .tree-name{flex:1;min-width:0}
        .tree-children{margin-left:18px}
        .tree-toggle{cursor:pointer;font-size:12px;color:var(--text-secondary);width:14px;display:inline-block}
        .tree-collapsed .tree-children{display:none}
        .card-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .card-head h3{font-size:15px;font-weight:600}
        .card-body{padding:20px}

        /* Stats */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
        .stat{background:#fff;border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;box-shadow:var(--shadow-soft)}
        .stat-label{font-size:12px;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
        .stat-val{font-size:28px;font-weight:700}
        .stat-val.green{color:var(--success)}
        .stat-val.yellow{color:var(--warning)}
        .stat-val.red{color:var(--error)}
        .stat-val.blue{color:var(--brand-primary)}

        /* Buttons */
        .btn{padding:8px 16px;border:none;border-radius:3px;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
        .btn-primary{background:var(--brand-primary);color:#fff}.btn-primary:hover{background:var(--brand-primary-hover)}
        .btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#188a57}
        .btn-warning{background:var(--warning);color:#fff}.btn-warning:hover{background:#b97722}
        .btn-danger{background:var(--error);color:#fff}.btn-danger:hover{background:#a7323f}
        .btn-secondary{background:#fff;color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:#f0f1f7}
        .btn-sm{padding:5px 10px;font-size:12px}
        .btn-icon{padding:6px;width:32px;height:32px;justify-content:center}

        /* Tables */
        .table{width:100%;border-collapse:collapse}
        .table th{text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);padding:10px 16px;border-bottom:2px solid var(--border);font-weight:600}
        .table td{padding:12px 16px;border-bottom:1px solid #f4f5f7;font-size:13px;vertical-align:middle}
        .table tr:hover td{background:#fafbfc}
        .table .actions{display:flex;gap:6px;justify-content:flex-end}
        .table-wrap{overflow:auto;width:100%}
        .table-wrap .table{min-width:640px}

        /* Status badges */
        .badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .badge.operational{background:#e3fcef;color:#006644}
        .badge.degraded_performance{background:#fff3cd;color:#856404}
        .badge.partial_outage{background:#ffeeba;color:#856404}
        .badge.major_outage{background:#f8d7da;color:#721c24}
        .badge.under_maintenance{background:#ece6ff;color:#4a2ea6}
        .badge.investigating{background:#fff3cd;color:#856404}
        .badge.identified{background:#ffeeba;color:#856404}
        .badge.monitoring{background:#cce5ff;color:#004085}
        .badge.resolved{background:#e3fcef;color:#006644}
        .badge.scheduled{background:#cce5ff;color:#004085}
        .badge.in_progress{background:#fff3cd;color:#856404}
        .badge.completed{background:#e3fcef;color:#006644}
        .badge-dot{width:6px;height:6px;border-radius:50%;background:currentColor}

        /* Modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;align-items:center;justify-content:center}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;border-radius:var(--radius-md);width:90%;max-width:600px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.2)}
        .modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .modal-head h3{font-size:18px;font-weight:600}
        .modal-close{background:none;border:none;font-size:20px;color:var(--text-secondary);cursor:pointer;padding:4px}
        .modal-body{padding:20px 24px;overflow-y:auto;flex:1}
        .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;flex-shrink:0}

        /* Forms */
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:6px}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;transition:border-color .15s}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--brand-primary);box-shadow:0 0 0 2px rgba(135,56,255,.2)}
        .form-group textarea{min-height:80px;resize:vertical}
        .form-group .check-group{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
        .form-group .check-item{display:flex;align-items:center;gap:6px;font-size:13px;padding:4px 8px;background:#f7f8f9;border-radius:3px;cursor:pointer}
        .form-group .check-item input{width:auto;margin:0}

        /* Timeline for incident updates */
        .timeline{position:relative;padding-left:24px}
        .timeline::before{content:'';position:absolute;left:8px;top:4px;bottom:4px;width:2px;background:var(--border)}
        .timeline-item{position:relative;padding-bottom:16px}
        .timeline-item:last-child{padding-bottom:0}
        .timeline-dot{position:absolute;left:-20px;top:4px;width:12px;height:12px;border-radius:50%;border:2px solid #e8ebef;background:#fff}
        .timeline-dot.investigating{border-color:var(--warning);background:var(--warning)}
        .timeline-dot.identified{border-color:#e26b38;background:#e26b38}
        .timeline-dot.monitoring{border-color:var(--brand-primary);background:var(--brand-primary)}
        .timeline-dot.resolved{border-color:var(--success);background:var(--success)}
        .timeline-status{font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:2px}
        .timeline-msg{font-size:13px;color:#333;margin-bottom:2px}
        .timeline-time{font-size:11px;color:var(--text-secondary)}

        /* Empty state */
        .empty{text-align:center;padding:40px 20px;color:var(--text-secondary)}
        .empty-icon{font-size:32px;margin-bottom:8px}

        /* Toast */
        .toast{position:fixed;bottom:24px;right:24px;background:var(--brand-deep-purple);color:#fff;padding:12px 20px;border-radius:var(--radius-sm);font-size:13px;z-index:200;transform:translateY(80px);opacity:0;transition:all .3s}
        .toast.show{transform:translateY(0);opacity:1}

        /* Tab content */
        .tab-page{display:none}
        .tab-page.active{display:block}
        .settings-subtabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px;border-bottom:1px solid var(--border);padding-bottom:10px}
        .settings-tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer}
        .settings-tab.active{background:var(--brand-primary);color:#fff;border-color:var(--brand-primary)}
        .settings-subpage{display:none}
        .settings-subpage.active{display:block}
        .settings-grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:16px 24px}
        .field-help{font-size:12px;color:#7a869a;margin-top:4px}
        .checkbox-row{display:flex;align-items:center;gap:8px}
        .analytics-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin:8px 0 18px}
        .analytics-card{border:1px solid var(--border);border-radius:8px;padding:12px;background:#fbfbfe}
        .analytics-card .label{font-size:11px;text-transform:uppercase;color:#7a869a;margin-bottom:4px}
        .analytics-card .value{font-size:22px;font-weight:700;color:#253858}
        .daily-analytics-table{width:100%;border-collapse:collapse}
        .daily-analytics-table th,.daily-analytics-table td{padding:8px 10px;border-bottom:1px solid #f1f2f7;font-size:12px;text-align:left}
        .activity-list{border:1px solid var(--border);border-radius:8px;background:#fff}
        .activity-item{padding:12px 14px;border-bottom:1px solid #f1f2f7}
        .activity-item:last-child{border-bottom:none}
        .activity-summary{font-size:13px;color:#172b4d;font-weight:600}
        .activity-meta{font-size:12px;color:#7a869a;margin-top:2px}
        .logo-drop{border:1px dashed rgba(9,30,66,.3);border-radius:8px;padding:18px;text-align:center;background:#fbfbfe;cursor:pointer}
        .logo-drop:hover{background:#f4f5fb}
        .logo-preview{max-height:64px;max-width:220px;object-fit:contain;margin:0 auto 10px;display:block}
        .logo-drop-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}

        /* Skip nav */
        .skip-nav{position:absolute;top:-40px;left:0;background:var(--brand-primary);color:#fff;padding:8px 16px;z-index:200;transition:top .2s}
        .skip-nav:focus{top:0}

        /* Hamburger */
        .hamburger{display:none;background:none;border:none;font-size:22px;cursor:pointer;padding:4px 8px;margin-right:8px;color:var(--text-primary);line-height:1}

        /* Button loading */
        .btn[disabled],.btn.btn-loading{opacity:.55;pointer-events:none;cursor:not-allowed}
        .btn.btn-loading::after{content:'';display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:btn-spin .6s linear infinite;margin-left:6px}
        @keyframes btn-spin{to{transform:rotate(360deg)}}

        /* Focus visible */
        :focus-visible{outline:2px solid var(--brand-primary);outline-offset:2px}

        @media(max-width:768px){
            .sidebar{display:none;position:fixed;top:0;left:0;width:260px;height:100vh;z-index:60}
            .sidebar.open{display:flex}
            .sidebar-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:55}
            .sidebar-backdrop.open{display:block}
            .hamburger{display:inline-flex}
            .main{margin-left:0}
            .topbar{padding:12px 16px}
            .content{padding:16px}
            .settings-grid{grid-template-columns:1fr}
        }
        @media(max-width:600px){
            .topbar{flex-direction:column;align-items:flex-start;gap:10px}
            .topbar-actions{width:100%;justify-content:space-between}
            .card-body{padding:16px}
            .stats{grid-template-columns:1fr}
            .tree-row{flex-direction:column;align-items:flex-start}
            .tree-row .actions{width:100%;justify-content:flex-end}
            .modal{width:95%;max-height:95vh}
            .form-group .check-group{flex-direction:column;align-items:flex-start}
        }

        /* ── Dark mode overrides ─────────────────────────────────────── */
        @media(prefers-color-scheme:dark){
            .topbar{background:var(--surface-elevated)}
            .project-select{background:var(--surface-elevated);color:var(--text-primary)}
            .card{background:var(--surface-elevated)}
            .stat{background:var(--surface-elevated)}
            .btn-secondary{background:var(--surface-elevated)}
            .table td{border-bottom-color:var(--border)}
            .table tr:hover td{background:rgba(255,255,255,.03)}
            .tree-node{border-bottom-color:var(--border)}
            .modal{background:var(--surface-elevated)}
            .timeline-dot{background:var(--surface-elevated);border-color:var(--border)}
            .timeline-msg{color:var(--text-primary)}
            .settings-tab{background:var(--surface-elevated)}
            .analytics-card{background:var(--surface-elevated)}
            .analytics-card .label{color:var(--text-secondary)}
            .analytics-card .value{color:var(--text-primary)}
            .daily-analytics-table th,.daily-analytics-table td{border-bottom-color:var(--border)}
            .activity-list{background:var(--surface-elevated)}
            .activity-item{border-bottom-color:var(--border)}
            .activity-summary{color:var(--text-primary)}
            .activity-meta{color:var(--text-secondary)}
            .logo-drop{background:var(--surface-elevated);border-color:var(--border)}
            .logo-drop:hover{background:var(--surface)}
            .form-group .check-item{background:var(--surface)}
            .field-help{color:var(--text-secondary)}
            .form-group input,.form-group select,.form-group textarea{background:var(--surface);color:var(--text-primary);border-color:var(--border)}
            .sidebar{background:var(--surface-elevated)}
        }
    </style>
</head>
<body>
<noscript><p style="padding:40px;text-align:center">JavaScript is required to use the admin panel.</p></noscript>

<a href="#main-content" class="skip-nav">Skip to content</a>
<div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>
<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <img id="adminSidebarLogo" class="brand-logo mark" src="/assets/brand/Elite-Logo-01.png" alt="Elite">
            <span>3E Elite Status</span>
        </div>
        <div class="sidebar-tools">
            <select id="projectSelect" class="project-select"></select>
            <a id="viewStatusLink" href="/index.html" class="nav-item" target="_blank"><span class="icon">&#128279;</span> View Status Page</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-label">Dashboard</div>
                <div class="nav-item active" data-tab="dashboard" onclick="showTab('dashboard')"><span class="icon">&#9632;</span> Overview</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Manage</div>
                <div class="nav-item" data-tab="components" onclick="showTab('components')" tabindex="0" role="button"><span class="icon">&#9881;</span> Components</div>
                <div class="nav-item" data-tab="incidents" onclick="showTab('incidents')" tabindex="0" role="button"><span class="icon">&#9888;</span> Incidents</div>
                <div class="nav-item" data-tab="maintenance" onclick="showTab('maintenance')" tabindex="0" role="button"><span class="icon">&#128736;</span> Maintenance</div>
                <div class="nav-item" data-tab="subscribers" onclick="showTab('subscribers')" tabindex="0" role="button"><span class="icon">&#9993;</span> Subscribers</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Configure</div>
                <div class="nav-item" data-tab="projects" onclick="showTab('projects')" tabindex="0" role="button"><span class="icon">&#128193;</span> Projects</div>
                <div class="nav-item" data-tab="users" onclick="showTab('users')" tabindex="0" role="button"><span class="icon">&#128101;</span> Users</div>
                <div class="nav-item" data-tab="settings" onclick="showTab('settings')" tabindex="0" role="button"><span class="icon">&#9881;</span> Settings</div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-badge">
                <div class="user-avatar" id="userInitials">AD</div>
                <div class="user-meta">
                    <div class="name" id="userName">Admin</div>
                    <div class="role">Administrator</div>
                </div>
            </div>
        </div>
    </aside>

    <div class="main" role="main">
        <div class="topbar">
            <div style="display:flex;align-items:center">
                <button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()" aria-label="Open navigation menu">&#9776;</button>
                <div class="topbar-title" id="pageTitle">Dashboard</div>
            </div>
            <div class="topbar-actions">
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="content" id="main-content">
            <!-- Dashboard -->
            <div class="tab-page active" id="tab-dashboard">
                <div class="stats" id="statsGrid"></div>
                <div class="card">
                    <div class="card-head"><h3>Quick Actions</h3></div>
                    <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap">
                        <button class="btn btn-primary" id="qaIncidentBtn" onclick="showTab('incidents');openIncidentModal()">Report Incident</button>
                        <button class="btn btn-primary" id="qaMaintenanceBtn" onclick="showTab('maintenance');openMaintenanceModal()">Schedule Maintenance</button>
                        <button class="btn btn-secondary" id="qaComponentBtn" onclick="showTab('components');openComponentModal()">Add Component</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-head"><h3>Recent Incidents</h3></div>
                    <div class="card-body" id="recentIncidents"></div>
                </div>
            </div>

            <!-- Components -->
            <div class="tab-page" id="tab-components">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Components</h2>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <label for="componentScopeSelect" style="font-size:12px;color:#7a869a;font-weight:600">Scope</label>
                    <select id="componentScopeSelect" class="project-select" style="min-width:220px" onchange="onComponentScopeChange(this.value)"></select>
                    <button class="btn btn-primary" id="componentsAddBtn" onclick="openComponentModal()">+ Component</button>
                    </div>
                </div>
                <div id="componentScopeNote" class="field-help" style="margin-bottom:10px">Components are managed for the selected scope.</div>
                <div class="card" style="margin-bottom:16px">
                    <div class="card-head"><h3>Components Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group" style="max-width:360px">
                            <label>Uptime Section</label>
                            <select id="showUptime" onchange="saveShowUptime()">
                                <option value="true">Show (Default)</option>
                                <option value="false">Hide</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="componentsList"></div>
            </div>

            <!-- Incidents -->
            <div class="tab-page" id="tab-incidents">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Incidents</h2>
                    <button class="btn btn-primary" id="incidentsAddBtn" onclick="openIncidentModal()">+ Create Incident</button>
                </div>
                <div class="card">
                    <div class="card-head">
                        <h3>Incident Templates</h3>
                        <button class="btn btn-secondary" id="incidentTemplateAddBtn" onclick="openIncidentTemplateModal()">+ New Template</button>
                    </div>
                    <div class="card-body" id="incidentTemplatesList"></div>
                </div>
                <div id="incidentsList"></div>
            </div>

            <!-- Maintenance -->
            <div class="tab-page" id="tab-maintenance">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Scheduled Maintenance</h2>
                    <button class="btn btn-primary" id="maintenanceAddBtn" onclick="openMaintenanceModal()">+ Schedule Maintenance</button>
                </div>
                <div class="card">
                    <div class="card-head">
                        <h3>Maintenance Templates</h3>
                        <button class="btn btn-secondary" id="maintenanceTemplateAddBtn" onclick="openMaintenanceTemplateModal()">+ New Template</button>
                    </div>
                    <div class="card-body" id="maintenanceTemplatesList"></div>
                </div>
                <div id="maintenanceList"></div>
            </div>

            <!-- Subscribers -->
            <div class="tab-page" id="tab-subscribers">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Subscribers</h2>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" id="subscribersImportBtn" onclick="openImportSubscribersModal()">Import Emails</button>
                        <button class="btn btn-secondary" id="subscribersExportBtn" onclick="openExportSubscribersModal()">Export Emails</button>
                    </div>
                </div>
                <div id="subscribersList"></div>
            </div>

            <!-- Projects -->
            <div class="tab-page" id="tab-projects">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Projects</h2>
                    <button class="btn btn-primary" id="projectsAddBtn" onclick="openProjectModal()">+ New Project</button>
                </div>
                <div class="card">
                    <div class="card-head"><h3>Project View Mode</h3></div>
                    <div class="card-body">
                        <div id="projectViewTargetHint" class="field-help" style="margin-bottom:12px"></div>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label>View Mode</label>
                                <select id="projectViewModeSelect" onchange="onProjectViewModeChange(this.value)">
                                    <option value="single">Disabled</option>
                                    <option value="dual">Dual View</option>
                                    <option value="triad">Triad View</option>
                                </select>
                                <div class="field-help">Disabled shows only Project 1. Dual shows Project 1 + Project 2. Triad shows Project 1 + Project 2 + Project 3.</div>
                            </div>
                            <div class="form-group">
                                <label>Project 1 (Primary)</label>
                                <select id="projectPrimarySelect" onchange="onProjectPrimaryChange(this.value)"></select>
                                <div class="field-help">Save always updates Project 1. Incidents and maintenance also come from Project 1.</div>
                            </div>
                            <div class="form-group" id="projectSecondaryWrap">
                                <label>Project 2 (Secondary)</label>
                                <select id="projectSecondarySelect" onchange="onProjectSecondaryChange(this.value)"></select>
                                <div class="field-help">Used for components in Dual or Triad mode. Choose Disabled to skip.</div>
                            </div>
                            <div class="form-group" id="projectTertiaryWrap">
                                <label>Project 3 (Tertiary)</label>
                                <select id="projectTertiarySelect" onchange="onProjectTertiaryChange(this.value)"></select>
                                <div class="field-help">Used only in Triad mode. Choose Disabled to skip.</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="projectViewSaveBtn" onclick="saveProjectViewMode()">Save View Mode</button>
                    </div>
                </div>
                <div id="projectsList"></div>
            </div>

            <!-- Users -->
            <div class="tab-page" id="tab-users">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h2 style="font-size:16px">Users</h2>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-secondary" onclick="loadUsers()">Refresh</button>
                        <button class="btn btn-primary" onclick="openUserModal()">+ New User</button>
                    </div>
                </div>
                <div id="usersList"></div>
            </div>

            <!-- Settings -->
            <div class="tab-page" id="tab-settings">
                <div class="card">
                    <div class="card-head"><h3>Status Page Settings</h3></div>
                    <div class="card-body">
                        <div class="settings-subtabs">
                            <button type="button" class="settings-tab active" id="settingsTabBtn-page-info" onclick="showSettingsSubtab('page-info')">Page Info</button>
                            <button type="button" class="settings-tab" id="settingsTabBtn-custom-domain" onclick="showSettingsSubtab('custom-domain')">Custom Domain</button>
                            <button type="button" class="settings-tab" id="settingsTabBtn-custom-email" onclick="showSettingsSubtab('custom-email')">Custom Email</button>
                            <button type="button" class="settings-tab" id="settingsTabBtn-analytics" onclick="showSettingsSubtab('analytics')">Analytics</button>
                            <button type="button" class="settings-tab" id="settingsTabBtn-activity-log" onclick="showSettingsSubtab('activity-log')">Activity Log</button>
                            <button type="button" class="settings-tab" id="settingsTabBtn-admin-panel" onclick="showSettingsSubtab('admin-panel')">Admin Panel</button>
                        </div>
                        <form id="settingsForm">
                            <div class="settings-subpage active" id="settings-subtab-page-info">
                                <div class="settings-grid">
                                    <div class="form-group">
                                        <label>Organization legal name</label>
                                        <input type="text" id="setOrganizationLegalName">
                                        <div class="field-help">Used only for invoicing purposes.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Page name</label>
                                        <input type="text" id="setPageName">
                                        <div class="field-help">The public name of your website or service.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Company website URL</label>
                                        <input type="url" id="setCompanyUrl" placeholder="https://yourcompany.com">
                                        <div class="field-help">Clicking the header logo on the status page forwards here.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Support URL</label>
                                        <input type="url" id="setSupportUrl" placeholder="https://support.yourcompany.com">
                                    </div>
                                    <div class="form-group">
                                        <label>Privacy policy URL</label>
                                        <input type="url" id="setPrivacyPolicyUrl" placeholder="https://yourcompany.com/privacy-policy">
                                        <div class="field-help">Link shown to subscribers.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Default SMS country code</label>
                                        <select id="setSmsCountryCode">
                                            <option value="+1">United States (+1)</option>
                                            <option value="+44">United Kingdom (+44)</option>
                                            <option value="+61">Australia (+61)</option>
                                            <option value="+91">India (+91)</option>
                                            <option value="+65">Singapore (+65)</option>
                                        </select>
                                        <div class="field-help">Default country code for SMS subscribers.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Page time zone</label>
                                        <select id="setTimezone">
                                            <option>UTC</option><option>America/New_York</option><option>America/Chicago</option><option>America/Denver</option><option>America/Los_Angeles</option><option>Europe/London</option><option>Europe/Paris</option><option>Asia/Tokyo</option><option>Asia/Shanghai</option><option>Australia/Sydney</option>
                                        </select>
                                        <div class="field-help">Timezone your page uses for timestamps.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Support Email</label>
                                        <input type="email" id="setSupportEmail">
                                    </div>
                                    <div class="form-group">
                                        <label>Public page title</label>
                                        <input type="text" id="setPageTitle">
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>About This Site</label>
                                        <textarea id="setAboutText" placeholder="Add a short description for your status page."></textarea>
                                    </div>
                                    <div class="form-group checkbox-row" style="grid-column:1/-1">
                                        <input type="checkbox" id="setHideFromSearchEngines" style="width:auto">
                                        <label for="setHideFromSearchEngines" style="margin:0">Hide my status page from search engines</label>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-subpage" id="settings-subtab-custom-domain">
                                <div class="form-group">
                                    <label>Custom Domain</label>
                                    <input type="text" id="setCustomDomain" placeholder="status.example.com">
                                    <div class="field-help">Primary publish domain for this project.</div>
                                </div>
                                <div class="form-group">
                                    <label>Redirect Domains</label>
                                    <textarea id="setRedirectDomains" placeholder="status-old.example.com&#10;status-alt.example.com"></textarea>
                                    <div class="field-help">One domain per line (or comma-separated). Each will redirect to the custom domain.</div>
                                </div>
                                <div class="form-group">
                                    <label>Automation Provider</label>
                                    <select id="setDomainAutomationProvider">
                                        <option value="firebase_hosting">Firebase Hosting</option>
                                        <option value="manual">Manual</option>
                                    </select>
                                    <div class="field-help">Use Firebase Hosting automation to create domain mappings and managed SSL.</div>
                                </div>
                                <div class="form-group">
                                    <label>Registrar</label>
                                    <input type="text" id="setDomainRegistrar" placeholder="GoDaddy, Namecheap, Cloudflare Registrar">
                                    <div class="field-help">Required when a custom domain is set.</div>
                                </div>
                                <div class="form-group">
                                    <label>DNS Provider</label>
                                    <input type="text" id="setDnsProvider" placeholder="Cloudflare, Route 53, Cloud DNS">
                                    <div class="field-help">Required when a custom domain is set.</div>
                                </div>
                                <div class="form-group">
                                    <label>Domain Contact Email</label>
                                    <input type="email" id="setDomainContactEmail" placeholder="dns-admin@example.com">
                                    <div class="field-help">Required for ownership and certificate coordination.</div>
                                </div>
                                <div class="form-group">
                                    <label>DNS Account / Team ID</label>
                                    <input type="text" id="setDnsProviderAccountId" placeholder="Optional account or team reference">
                                </div>
                                <div class="form-group">
                                    <label>DNS Zone</label>
                                    <input type="text" id="setDnsProviderZone" placeholder="example-com">
                                </div>
                                <div class="form-group">
                                    <label>Publish URL</label>
                                    <div id="publishUrlPreview" style="font-size:13px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#f7f8f9;color:#253858"></div>
                                </div>
                                <div class="form-group">
                                    <label>Expected DNS Target</label>
                                    <input type="text" id="dnsExpectedTarget" readonly>
                                    <div id="dnsInstructionPrimary" class="field-help">Configure DNS for your custom domain to point to this target.</div>
                                </div>
                                <div class="form-group">
                                    <label>Redirect Domain DNS</label>
                                    <div id="dnsInstructionRedirect" class="field-help">Redirect domains should point to your primary custom domain or same app target.</div>
                                </div>
                                <div class="form-group">
                                    <button type="button" class="btn btn-secondary" onclick="validateProjectDomains()">Validate DNS</button>
                                    <div id="dnsValidationResults" style="margin-top:10px;font-size:12px;color:#42526e;background:#f7f8f9;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px">Validation not run yet.</div>
                                </div>
                                <div class="form-group" style="grid-column:1/-1">
                                    <button type="button" class="btn btn-secondary" onclick="provisionProjectDomains()">Provision in Firebase Hosting</button>
                                    <button type="button" class="btn btn-secondary" onclick="loadDomainProvisionStatus()" style="margin-left:8px">Refresh Provision Status</button>
                                    <div id="domainProvisionResults" style="margin-top:10px;font-size:12px;color:#42526e;background:#f7f8f9;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px">Provisioning not run yet.</div>
                                </div>
                            </div>

                            <div class="settings-subpage" id="settings-subtab-custom-email">
                                <div class="form-group">
                                    <label>Logo</label>
                                    <div id="emailLogoDrop" class="logo-drop" onclick="triggerEmailLogoUpload()">
                                        <img id="emailLogoPreview" class="logo-preview" src="/assets/brand/Elite-Logo-01.png" alt="Email logo preview" style="display:none">
                                        <div id="emailLogoPlaceholder">
                                            <div style="font-size:14px;font-weight:600;color:#253858;margin-bottom:4px">Drag file here</div>
                                            <div class="field-help">or click Upload image</div>
                                        </div>
                                        <div class="logo-drop-actions">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation();triggerEmailLogoUpload();">Upload image</button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation();copyLogoFromStatusPage();">Copy logo from status page</button>
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation();clearEmailLogo();">Clear</button>
                                        </div>
                                    </div>
                                    <input type="file" id="emailLogoFileInput" accept="image/*" style="display:none">
                                    <input type="hidden" id="setNotificationLogoUrl">
                                </div>
                                <div class="settings-grid">
                                    <div class="form-group">
                                        <label>Send from name</label>
                                        <input type="text" id="setNotificationFromName" placeholder="Your company name">
                                    </div>
                                    <div class="form-group">
                                        <label>Send from email</label>
                                        <input type="email" id="setNotificationFromEmail" placeholder="status@company.com">
                                        <div class="field-help">Notifications are sent from this address (requires DNS setup).</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Reply to email</label>
                                        <input type="email" id="setNotificationReplyToEmail" placeholder="support@company.com">
                                        <div class="field-help">Replies from subscribers are sent to this address.</div>
                                    </div>
                                    <div class="form-group checkbox-row">
                                        <input type="checkbox" id="setNotificationUseStatusLogo" style="width:auto">
                                        <label for="setNotificationUseStatusLogo" style="margin:0">Use status page logo for emails</label>
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>Footer message</label>
                                        <textarea id="setNotificationFooterMessage" placeholder="You received this email because you are subscribed..."></textarea>
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>Effective sender</label>
                                        <input type="text" id="setEffectiveNotificationFromEmail" readonly>
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>Email Delivery Service</label>
                                        <div id="emailServiceStatus" style="font-size:12px;color:#42526e;background:#f7f8f9;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px">Status not checked yet.</div>
                                        <div class="field-help">Server-side SMTP config is required. Missing settings are shown here.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Test Recipient</label>
                                        <input type="email" id="emailTestRecipient" placeholder="you@example.com">
                                    </div>
                                    <div class="form-group">
                                        <label>Test Subject</label>
                                        <input type="text" id="emailTestSubject" placeholder="Status page test">
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>Test Message</label>
                                        <textarea id="emailTestMessage" placeholder="This is a test email from our status page."></textarea>
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <button type="button" class="btn btn-secondary" onclick="loadEmailServiceStatus()">Refresh Email Status</button>
                                        <button type="button" class="btn btn-secondary" onclick="sendTestEmail()" style="margin-left:8px">Send Test Email</button>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-subpage" id="settings-subtab-analytics">
                                <div class="settings-grid">
                                    <div class="form-group">
                                        <label>Google Analytics tracking</label>
                                        <input type="text" id="setGaTrackingId" placeholder="G-XXXXXXXXXX">
                                        <div class="field-help">Paste your GA Measurement ID.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Brand Color</label>
                                        <input type="color" id="setBrandColor" style="width:60px;height:36px;padding:2px">
                                    </div>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                    <h3 style="font-size:14px;margin:0">Page Analytics</h3>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="loadAnalyticsData()">Refresh</button>
                                </div>
                                <div class="analytics-cards" id="analyticsCards"></div>
                                <div class="card" style="box-shadow:none">
                                    <div class="card-head"><h3>Daily Views</h3></div>
                                    <div class="card-body" id="analyticsDailyTable"></div>
                                </div>
                            </div>

                            <div class="settings-subpage" id="settings-subtab-activity-log">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                    <h3 style="font-size:14px;margin:0">Recent Changes</h3>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="loadActivityLog()">Refresh</button>
                                </div>
                                <div id="activityLogList" class="activity-list">
                                    <div class="activity-item">
                                        <div class="activity-summary">No activity yet.</div>
                                        <div class="activity-meta">Changes by admins/editors will appear here.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-subpage" id="settings-subtab-admin-panel">
                                <div class="settings-grid">
                                    <div class="form-group">
                                        <label>Main page logo</label>
                                        <div id="statusLogoDrop" class="logo-drop" onclick="triggerStatusLogoUpload()">
                                            <img id="statusLogoPreview" class="logo-preview" src="/assets/brand/Elite-Logo-01.png" alt="Status page logo preview">
                                            <div class="field-help">Used on public status page header/footer.</div>
                                            <div class="logo-drop-actions">
                                                <button type="button" class="btn btn-primary btn-sm" id="statusLogoUploadBtn" onclick="event.stopPropagation();triggerStatusLogoUpload();">Upload image</button>
                                                <button type="button" class="btn btn-secondary btn-sm" id="statusLogoCopyFromAdminBtn" onclick="event.stopPropagation();copyAdminLogoToStatusLogo();">Copy from admin logo</button>
                                                <button type="button" class="btn btn-secondary btn-sm" id="statusLogoResetBtn" onclick="event.stopPropagation();resetStatusPageLogo();">Reset default</button>
                                            </div>
                                        </div>
                                        <input type="file" id="statusLogoFileInput" accept="image/*" style="display:none">
                                        <input type="hidden" id="setStatusPageLogoUrl">
                                    </div>
                                    <div class="form-group">
                                        <label>Admin panel logo</label>
                                        <div id="adminPanelLogoDrop" class="logo-drop" onclick="triggerAdminPanelLogoUpload()">
                                            <img id="adminPanelLogoPreview" class="logo-preview" src="/assets/brand/Elite-Logo-01.png" alt="Admin panel logo preview">
                                            <div class="field-help">Used on admin sidebar/footer and browser icon.</div>
                                            <div class="logo-drop-actions">
                                                <button type="button" class="btn btn-primary btn-sm" id="adminLogoUploadBtn" onclick="event.stopPropagation();triggerAdminPanelLogoUpload();">Upload image</button>
                                                <button type="button" class="btn btn-secondary btn-sm" id="adminLogoCopyFromStatusBtn" onclick="event.stopPropagation();copyStatusLogoToAdminLogo();">Copy from main page logo</button>
                                                <button type="button" class="btn btn-secondary btn-sm" id="adminLogoResetBtn" onclick="event.stopPropagation();resetAdminPanelLogo();">Reset default</button>
                                            </div>
                                        </div>
                                        <input type="file" id="adminPanelLogoFileInput" accept="image/*" style="display:none">
                                        <input type="hidden" id="setAdminPanelLogoUrl">
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <label>Disable menu items</label>
                                        <div class="check-group">
                                            <label class="check-item"><input type="checkbox" id="toggle-components"> Components</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-incidents"> Incidents</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-maintenance"> Maintenance</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-subscribers"> Subscribers</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-projects"> Projects</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-users"> Users</label>
                                            <label class="check-item"><input type="checkbox" id="toggle-settings"> Settings</label>
                                        </div>
                                    </div>
                                    <div class="form-group" style="grid-column:1/-1">
                                        <button type="button" class="btn btn-primary" id="menuSaveBtn" onclick="saveMenuVisibility()">Save Menu Visibility</button>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top:16px">
                            <button type="submit" class="btn btn-primary" id="settingsSaveBtn">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="app-footer">
    <div class="footer-inner">
        <div class="brand">
            <img id="adminFooterLogo" class="brand-logo full" src="/assets/brand/Elite-Logo-01.png" alt="Elite Status">
        </div>
        <div class="footer-links">
            <a href="/index.html">Status Home</a>
            <a href="/admin.html">Admin</a>
        </div>
        <div class="muted">Enterprise status management</div>
    </div>
</footer>

<!-- Component Modal -->
<div class="modal-overlay" id="componentModal" role="dialog" aria-modal="true" aria-labelledby="componentModalTitle">
    <div class="modal">
        <div class="modal-head"><h3 id="componentModalTitle">Add Component</h3><button class="modal-close" onclick="closeModal('componentModal')">&times;</button></div>
        <div class="modal-body">
            <form id="componentForm">
                <div class="form-group"><label>Name</label><input type="text" id="compName" required></div>
                <div class="form-group"><label>Description</label><input type="text" id="compDesc"></div>
                <div class="form-group"><label>Parent Component</label><select id="compParent"></select></div>
                <div class="form-group"><label>Status</label>
                    <select id="compStatus">
                        <option value="operational">Operational</option>
                        <option value="degraded_performance">Degraded Performance</option>
                        <option value="partial_outage">Partial Outage</option>
                        <option value="major_outage">Major Outage</option>
                        <option value="under_maintenance">Under Maintenance</option>
                    </select>
                </div>
                <input type="hidden" id="compId">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('componentModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveComponent()">Save</button>
        </div>
    </div>
</div>

<!-- Incident Modal -->
<div class="modal-overlay" id="incidentModal" role="dialog" aria-modal="true" aria-labelledby="incidentModalTitle">
    <div class="modal">
        <div class="modal-head"><h3>Create Incident</h3><button class="modal-close" onclick="closeModal('incidentModal')">&times;</button></div>
        <div class="modal-body">
            <form id="incidentForm">
                <div class="form-group"><label>Title</label><input type="text" id="incTitle" required placeholder="Brief description of the incident"></div>
                <div class="form-group"><label>Status</label>
                    <select id="incStatus"><option value="investigating">Investigating</option><option value="identified">Identified</option><option value="monitoring">Monitoring</option><option value="resolved">Resolved</option></select>
                </div>
                <div class="form-group"><label>Impact</label>
                    <select id="incImpact"><option value="none">None</option><option value="minor" selected>Minor</option><option value="major">Major</option><option value="critical">Critical</option></select>
                </div>
                <div class="form-group"><label>Affected Components</label><div class="check-group" id="incComponents"></div></div>
                <div class="form-group"><label>Message</label><textarea id="incMessage" required placeholder="Describe what's happening..."></textarea></div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('incidentModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveIncident()">Create Incident</button>
        </div>
    </div>
</div>

<!-- Incident Update Modal -->
<div class="modal-overlay" id="updateModal" role="dialog" aria-modal="true" aria-labelledby="updateModalTitle">
    <div class="modal" style="max-width:500px">
        <div class="modal-head"><h3 id="updateModalTitle">Post Incident Update</h3><button class="modal-close" onclick="closeModal('updateModal')" aria-label="Close">&times;</button></div>
        <div class="modal-body">
            <div class="form-group"><label>Status</label>
                <select id="updStatus"><option value="investigating">Investigating</option><option value="identified">Identified</option><option value="monitoring">Monitoring</option><option value="resolved">Resolved</option></select>
            </div>
            <div class="form-group"><label>Message</label><textarea id="updMessage" required placeholder="Update message..."></textarea></div>
            <input type="hidden" id="updIncidentId">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('updateModal')">Cancel</button>
            <button class="btn btn-primary" onclick="postIncidentUpdate()">Post Update</button>
        </div>
    </div>
</div>

<!-- Incident Template Modal -->
<div class="modal-overlay" id="incidentTemplateModal" role="dialog" aria-modal="true" aria-labelledby="incidentTemplateModalTitle">
    <div class="modal">
        <div class="modal-head"><h3 id="incidentTemplateModalTitle">New Incident Template</h3><button class="modal-close" onclick="closeModal('incidentTemplateModal')">&times;</button></div>
        <div class="modal-body">
            <form id="incidentTemplateForm">
                <div class="form-group"><label>Template Name</label><input type="text" id="incidentTemplateName" required placeholder="Service degradation"></div>
                <div class="form-group"><label>Incident Title</label><input type="text" id="incidentTemplateTitle" required placeholder="Service performance degradation"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label>Default Status</label>
                        <select id="incidentTemplateStatus">
                            <option value="investigating">Investigating</option>
                            <option value="identified">Identified</option>
                            <option value="monitoring">Monitoring</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Default Impact</label>
                        <select id="incidentTemplateImpact">
                            <option value="none">None</option>
                            <option value="minor" selected>Minor</option>
                            <option value="major">Major</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Default Message</label><textarea id="incidentTemplateMessage" required placeholder="Describe what users should know..."></textarea></div>
                <div class="form-group"><label>Default Affected Components</label><div class="check-group" id="incidentTemplateComponents"></div></div>
                <input type="hidden" id="incidentTemplateId">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('incidentTemplateModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveIncidentTemplate()">Save Template</button>
        </div>
    </div>
</div>

<!-- Maintenance Modal -->
<div class="modal-overlay" id="maintenanceModal" role="dialog" aria-modal="true" aria-labelledby="maintenanceModalTitle">
    <div class="modal">
                <div class="modal-head"><h3 id="maintenanceModalTitle">Schedule Maintenance</h3><button class="modal-close" onclick="closeModal('maintenanceModal')">&times;</button></div>
        <div class="modal-body">
            <form id="maintenanceForm">
                <div class="form-group"><label>Title</label><input type="text" id="maintTitle" required></div>
                <div class="form-group"><label>Message</label><textarea id="maintMessage" placeholder="Describe the maintenance..."></textarea></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label>Start</label><input type="datetime-local" id="maintStart" required></div>
                    <div class="form-group"><label>End</label><input type="datetime-local" id="maintEnd" required></div>
                </div>
                <div class="form-group"><label>Affected Components</label><div class="check-group" id="maintComponents"></div></div>
                <input type="hidden" id="maintId">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveMaintenance()">Schedule</button>
        </div>
    </div>
</div>

<!-- Maintenance Template Modal -->
<div class="modal-overlay" id="maintenanceTemplateModal" role="dialog" aria-modal="true" aria-labelledby="maintenanceTemplateModalTitle">
    <div class="modal">
        <div class="modal-head"><h3 id="maintenanceTemplateModalTitle">New Maintenance Template</h3><button class="modal-close" onclick="closeModal('maintenanceTemplateModal')">&times;</button></div>
        <div class="modal-body">
            <form id="maintenanceTemplateForm">
                <div class="form-group"><label>Template Name</label><input type="text" id="maintenanceTemplateName" required placeholder="Weekly maintenance window"></div>
                <div class="form-group"><label>Maintenance Title</label><input type="text" id="maintenanceTemplateTitle" required placeholder="Scheduled maintenance window"></div>
                <div class="form-group"><label>Default Message</label><textarea id="maintenanceTemplateMessage" placeholder="Message shown when this template is used..."></textarea></div>
                <div class="form-group"><label>Default Duration (minutes)</label><input type="number" id="maintenanceTemplateDuration" min="5" max="10080" step="1" value="60" required></div>
                <div class="form-group"><label>Default Affected Components</label><div class="check-group" id="maintenanceTemplateComponents"></div></div>
                <input type="hidden" id="maintenanceTemplateId">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('maintenanceTemplateModal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveMaintenanceTemplate()">Save Template</button>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal-overlay" id="projectModal" role="dialog" aria-modal="true" aria-labelledby="projectModalTitle">
    <div class="modal" style="max-width:420px">
        <div class="modal-head"><h3 id="projectModalTitle">New Project</h3><button class="modal-close" onclick="closeModal('projectModal')">&times;</button></div>
        <div class="modal-body">
            <form id="projectForm">
                <div class="form-group"><label>Project Name</label><input type="text" id="projName" required></div>
                <div class="form-group"><label>Project Slug</label><input type="text" id="projSlug" placeholder="optional"></div>
                <input type="hidden" id="projId">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveProject()">Save</button>
        </div>
    </div>
</div>

<!-- User Modal -->
<div class="modal-overlay" id="userModal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
    <div class="modal" style="max-width:420px">
        <div class="modal-head"><h3 id="userModalTitle">New User</h3><button class="modal-close" onclick="closeModal('userModal')">&times;</button></div>
        <div class="modal-body">
            <form id="userForm">
                <div class="form-group"><label>Name</label><input type="text" id="userNameInput"></div>
                <div class="form-group"><label>Company Email</label><input type="email" id="userEmail" required placeholder="name@company.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="userPassword" placeholder="Set a password" minlength="12"></div>
                <div class="form-group"><label>Role</label>
                    <select id="userRole">
                        <option value="admin">Admin</option>
                        <option value="editor">Editor</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <input type="hidden" id="userId">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
        </div>
    </div>
</div>

<!-- Export Subscribers Modal -->
<div class="modal-overlay" id="exportSubscribersModal" role="dialog" aria-modal="true" aria-labelledby="exportSubscribersModalTitle">
    <div class="modal" style="max-width:520px">
        <div class="modal-head">
            <h3 id="exportSubscribersModalTitle">Export Subscribers</h3>
            <button class="modal-close" onclick="closeModal('exportSubscribersModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:#7a869a;margin-bottom:14px">Export customer subscribers from this project. Only email subscribers are included.</p>
            <div class="settings-grid" style="grid-template-columns:1fr 1fr">
                <div class="form-group">
                    <label>Subscriber mode</label>
                    <label class="check-item"><input type="checkbox" checked disabled> Email</label>
                    <div class="field-help">SMS and webhook exports are disabled.</div>
                </div>
                <div class="form-group">
                    <label>Export format</label>
                    <label class="check-item"><input type="radio" name="subscriberExportFormat" value="csv" checked> CSV</label>
                    <label class="check-item"><input type="radio" name="subscriberExportFormat" value="json"> JSON</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('exportSubscribersModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="exportSubscribers()">Export subscribers</button>
        </div>
    </div>
</div>

<!-- Import Subscribers Modal -->
<div class="modal-overlay" id="importSubscribersModal" role="dialog" aria-modal="true" aria-labelledby="importSubscribersModalTitle">
    <div class="modal" style="max-width:560px">
        <div class="modal-head">
            <h3 id="importSubscribersModalTitle">Import Subscribers</h3>
            <button class="modal-close" onclick="closeModal('importSubscribersModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size:13px;color:#7a869a;margin-bottom:14px">Import email subscribers from CSV or JSON exported by a previous application.</p>
            <div class="form-group">
                <label>Selected file</label>
                <div id="subscriberImportFileName" style="font-size:13px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:#f7f8f9;color:#253858">No file selected.</div>
            </div>
            <div class="form-group checkbox-row">
                <input type="checkbox" id="subscriberImportReplace" style="width:auto">
                <label for="subscriberImportReplace" style="margin:0">Replace existing email subscribers</label>
            </div>
            <div class="field-help">Only valid, unique email addresses will be imported.</div>
            <input type="file" id="subscriberImportFileInput" accept=".csv,.json,text/csv,application/json" style="display:none">
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('importSubscribersModal')">Cancel</button>
            <button type="button" class="btn btn-secondary" onclick="triggerSubscriberImportFile()">Choose File</button>
            <button type="button" class="btn btn-primary" onclick="importSubscribers()">Import</button>
        </div>
    </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// ── Mobile sidebar toggle ─────────────────────────────────────────────────
function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('open');
    document.getElementById('sidebarBackdrop').classList.toggle('open');
}
function closeSidebar() {
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarBackdrop').classList.remove('open');
}

// ── Keyboard activation for nav items and interactive divs ────────────────
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
        const el = document.activeElement;
        if (el && el.getAttribute('role') === 'button' && el.onclick) {
            e.preventDefault();
            el.click();
        }
    }
});

// ── Button loading helper ─────────────────────────────────────────────────
async function withLoading(btn, asyncFn) {
    if (!btn) return asyncFn();
    const origText = btn.textContent;
    btn.classList.add('btn-loading');
    btn.disabled = true;
    try {
        return await asyncFn();
    } finally {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        btn.textContent = origText;
    }
}

// ── Auth ──────────────────────────────────────────────────────────────────
let API = localStorage.getItem('statusPageApiBase') || '';
if (!API && window.location.protocol === 'file:') {
    API = 'http://localhost:3000';
}
const headers = () => ({ 'Content-Type': 'application/json' });

async function api(method, url, body) {
    const opts = { method, headers: headers(), credentials: 'same-origin' };
    if (body) opts.body = JSON.stringify(body);
    let r;
    try {
        r = await fetch(API + url, opts);
    } catch (e) {
        toast('Network error: ' + (e.message || 'request failed'));
        throw e;
    }
    const contentType = r.headers.get('content-type') || '';
    if (r.status === 401) { localStorage.removeItem('statusPageUser'); window.location.href = '/login.html'; return; }
    if (!contentType.includes('application/json')) {
        if ((!API || API === window.location.origin) && window.location.port !== '3000') {
            try {
                const retry = await fetch('http://localhost:3000' + url, opts);
                const retryType = retry.headers.get('content-type') || '';
                if (retryType.includes('application/json')) return retry.json();
            } catch (e) {}
        }
        if (window.location.protocol === 'file:') {
            toast('Open the app via http://localhost:3000/admin.html (not file://)');
        }
        const text = await r.text();
        toast('API error: server did not return JSON');
        throw new Error('Non-JSON response: ' + text.slice(0, 120));
    }
    return r.json();
}

async function logout() {
    try { await fetch('/api/v1/auth/logout', { method: 'POST', credentials: 'same-origin' }); } catch {}
    localStorage.removeItem('statusPageUser');
    window.location.href = '/login.html';
}

let currentUserRole = 'viewer';
function canEdit() { return currentUserRole === 'admin' || currentUserRole === 'editor'; }
function isAdmin() { return currentUserRole === 'admin'; }
function isTabHiddenForCurrentUser(tabName) {
    if (!tabName) return false;
    if (!isAdmin() && tabName === 'users') return true;
    if (!isAdmin() && disabledTabs && disabledTabs[tabName]) return true;
    return false;
}
const DEFAULT_BRAND_LOGO_URL = '/assets/brand/Elite-Logo-01.png';

// ── Projects ─────────────────────────────────────────────────────────────
let projects = [];
let currentProjectId = null;
let currentProjectSlug = '';
let currentProjectCustomDomain = '';
let dualDisplayMode = 'single';
let dualSecondaryProjectId = null;
let dualTertiaryProjectId = null;
let activeComponentProjectId = null;
let projectViewConfig = { mode: 'single', primaryProjectId: null, secondaryProjectId: null, tertiaryProjectId: null };
const projectSelect = document.getElementById('projectSelect');
const projectForm = document.getElementById('projectForm');

projectForm.addEventListener('submit', (e) => {
    e.preventDefault();
    saveProject();
});

function projectPath(path) {
    if (!currentProjectId) return path;
    return '/api/v1/admin/projects/' + currentProjectId + path;
}

function adminProjectPath(projectId, path) {
    if (!projectId) return path;
    return '/api/v1/admin/projects/' + projectId + path;
}

function componentProjectPath(path) {
    return adminProjectPath(activeComponentProjectId || currentProjectId, path);
}

function normalizeDomainInput(value) {
    return (value || '')
        .trim()
        .replace(/^https?:\/\//i, '')
        .replace(/\/.*$/, '')
        .replace(/:\d+$/, '')
        .toLowerCase();
}

function parseRedirectDomainsInput(value) {
    const raw = String(value || '');
    const parts = raw.split(/[\n,]+/).map(normalizeDomainInput).filter(Boolean);
    return [...new Set(parts)];
}

function renderDomainValidation(result) {
    const panel = document.getElementById('dnsValidationResults');
    if (!panel) return;
    if (!result || result.error) {
        panel.innerHTML = `<div style="color:#bf2600">${esc((result && result.error) || 'Validation failed')}</div>`;
        return;
    }
    if (!result.results || !result.results.length) {
        panel.innerHTML = '<div style="color:#7a869a">No domains configured for validation.</div>';
        return;
    }
    panel.innerHTML = result.results.map((item) => {
        const color = item.status === 'ok' ? '#0b875b' : (item.status === 'warning' ? '#b38600' : '#bf2600');
        const notes = Array.isArray(item.notes) ? item.notes.join(' | ') : '';
        const cname = Array.isArray(item.cnameRecords) && item.cnameRecords.length ? item.cnameRecords.join(', ') : '-';
        const a = Array.isArray(item.aRecords) && item.aRecords.length ? item.aRecords.join(', ') : '-';
        const aaaa = Array.isArray(item.aaaaRecords) && item.aaaaRecords.length ? item.aaaaRecords.join(', ') : '-';
        return `<div style="padding:8px 0;border-bottom:1px solid #ebecf0">
            <div><strong>${esc(item.domain)}</strong> <span style="color:${color};font-weight:600;text-transform:uppercase">${esc(item.status)}</span></div>
            <div style="margin-top:4px">Expected: ${esc(item.expectedTarget || '-')}</div>
            <div>CNAME: ${esc(cname)}</div>
            <div>A: ${esc(a)}</div>
            <div>AAAA: ${esc(aaaa)}</div>
            <div style="margin-top:4px;color:${color}">${esc(notes || '-')}</div>
        </div>`;
    }).join('');
}

function renderDomainProvisionResults(payload) {
    const panel = document.getElementById('domainProvisionResults');
    if (!panel) return;
    if (!payload) {
        panel.innerHTML = '<div style="color:#7a869a">No provisioning data available.</div>';
        return;
    }
    if (payload.error) {
        panel.innerHTML = `<div style="color:#bf2600">${esc(payload.error)}</div>`;
        return;
    }
    const results = Array.isArray(payload.results) ? payload.results : [];
    if (!results.length) {
        panel.innerHTML = '<div style="color:#7a869a">No domain mappings found yet.</div>';
        return;
    }
    const sections = results.map((item) => {
        if (item.error) {
            return `<div style="padding:8px 0;border-bottom:1px solid #ebecf0">
                <div><strong>${esc(item.domain || '-')}</strong> <span style="color:#bf2600;font-weight:600">ERROR</span></div>
                <div style="margin-top:4px;color:#bf2600">${esc(item.error)}</div>
            </div>`;
        }
        const active = item.hostState === 'HOST_ACTIVE' && item.ownershipState === 'OWNERSHIP_ACTIVE' && (!item.certificateState || item.certificateState === 'CERT_ACTIVE');
        const color = active ? '#0b875b' : '#b38600';
        const desired = item.dns && Array.isArray(item.dns.desired) ? item.dns.desired : [];
        const desiredText = desired.length
            ? desired.map((r) => `${r.type || '?'} ${r.name || '?'} -> ${r.rdata || '?'} (${r.requiredAction || ''})`).join(' | ')
            : '-';
        const issues = Array.isArray(item.issues) && item.issues.length ? item.issues.join(' | ') : '-';
        return `<div style="padding:8px 0;border-bottom:1px solid #ebecf0">
            <div><strong>${esc(item.domain || '-')}</strong> <span style="color:${color};font-weight:600">${active ? 'ACTIVE' : 'PENDING'}</span></div>
            <div style="margin-top:4px">Host: ${esc(item.hostState || '-')} | Ownership: ${esc(item.ownershipState || '-')} | SSL: ${esc(item.certificateState || '-')}</div>
            <div style="margin-top:4px">Desired DNS: ${esc(desiredText)}</div>
            <div style="margin-top:4px">Issues: ${esc(issues)}</div>
        </div>`;
    });
    const actions = Array.isArray(payload.nextActions) && payload.nextActions.length
        ? `<div style="margin-top:8px;color:#42526e"><strong>Next:</strong> ${esc(payload.nextActions.join(' | '))}</div>`
        : '';
    panel.innerHTML = sections.join('') + actions;
}

async function loadDomainProvisionStatus() {
    const panel = document.getElementById('domainProvisionResults');
    if (panel) panel.textContent = 'Loading provisioning status...';
    const result = await api('GET', projectPath('/domain-provision-status'));
    renderDomainProvisionResults(result);
}

async function provisionProjectDomains() {
    if (!requireEdit()) return;
    const panel = document.getElementById('domainProvisionResults');
    if (panel) panel.textContent = 'Provisioning custom domains in Firebase Hosting...';
    const result = await api('POST', projectPath('/domain-provision'), {});
    renderDomainProvisionResults(result);
    if (result && result.error) {
        toast(result.error);
        return;
    }
    toast('Domain provisioning request completed');
}

function normalizedLogoUrl(value) {
    return String(value || '').trim() || DEFAULT_BRAND_LOGO_URL;
}

function applyAdminPanelBranding() {
    const logo = normalizedLogoUrl(document.getElementById('setAdminPanelLogoUrl') ? document.getElementById('setAdminPanelLogoUrl').value : '');
    ['adminSidebarLogo', 'adminFooterLogo'].forEach((id) => {
        const img = document.getElementById(id);
        if (img) img.src = logo;
    });
    const favicon = document.getElementById('adminFavicon');
    if (favicon) favicon.setAttribute('href', logo);
    const apple = document.getElementById('adminAppleIcon');
    if (apple) apple.setAttribute('href', logo);
    const og = document.getElementById('adminOgImage');
    if (og) og.setAttribute('content', logo);
    const twitter = document.getElementById('adminTwitterImage');
    if (twitter) twitter.setAttribute('content', logo);
}

function renderStatusLogoPreview() {
    const img = document.getElementById('statusLogoPreview');
    const value = normalizedLogoUrl(document.getElementById('setStatusPageLogoUrl').value);
    if (img) img.src = value;
}

function renderAdminPanelLogoPreview() {
    const img = document.getElementById('adminPanelLogoPreview');
    const value = normalizedLogoUrl(document.getElementById('setAdminPanelLogoUrl').value);
    if (img) img.src = value;
    applyAdminPanelBranding();
}

function triggerStatusLogoUpload() {
    const input = document.getElementById('statusLogoFileInput');
    if (input) input.click();
}

function triggerAdminPanelLogoUpload() {
    const input = document.getElementById('adminPanelLogoFileInput');
    if (input) input.click();
}

function setStatusLogoFromFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        document.getElementById('setStatusPageLogoUrl').value = String(reader.result || '');
        renderStatusLogoPreview();
    };
    reader.readAsDataURL(file);
}

function setAdminPanelLogoFromFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        document.getElementById('setAdminPanelLogoUrl').value = String(reader.result || '');
        renderAdminPanelLogoPreview();
    };
    reader.readAsDataURL(file);
}

function copyStatusLogoToAdminLogo() {
    document.getElementById('setAdminPanelLogoUrl').value = normalizedLogoUrl(document.getElementById('setStatusPageLogoUrl').value);
    renderAdminPanelLogoPreview();
}

function copyAdminLogoToStatusLogo() {
    document.getElementById('setStatusPageLogoUrl').value = normalizedLogoUrl(document.getElementById('setAdminPanelLogoUrl').value);
    renderStatusLogoPreview();
}

function resetStatusPageLogo() {
    document.getElementById('setStatusPageLogoUrl').value = DEFAULT_BRAND_LOGO_URL;
    renderStatusLogoPreview();
}

function resetAdminPanelLogo() {
    document.getElementById('setAdminPanelLogoUrl').value = DEFAULT_BRAND_LOGO_URL;
    renderAdminPanelLogoPreview();
}

function bindLogoDropTarget(input, drop, onFile) {
    if (!input || !drop) return;
    input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) onFile(file);
        input.value = '';
    });
    ['dragenter', 'dragover'].forEach((evt) => {
        drop.addEventListener(evt, (e) => {
            e.preventDefault();
            drop.style.borderColor = 'var(--brand-primary)';
        });
    });
    ['dragleave', 'drop'].forEach((evt) => {
        drop.addEventListener(evt, (e) => {
            e.preventDefault();
            drop.style.borderColor = 'rgba(9,30,66,.3)';
        });
    });
    drop.addEventListener('drop', (e) => {
        const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) onFile(file);
    });
}

function renderEmailLogoPreview() {
    const img = document.getElementById('emailLogoPreview');
    const placeholder = document.getElementById('emailLogoPlaceholder');
    const value = (document.getElementById('setNotificationLogoUrl').value || '').trim();
    if (!img || !placeholder) return;
    if (value) {
        img.src = value;
        img.style.display = 'block';
        placeholder.style.display = 'none';
    } else {
        img.style.display = 'none';
        placeholder.style.display = 'block';
    }
}

function triggerEmailLogoUpload() {
    const input = document.getElementById('emailLogoFileInput');
    if (input) input.click();
}

function setEmailLogoFromFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        document.getElementById('setNotificationLogoUrl').value = String(reader.result || '');
        document.getElementById('setNotificationUseStatusLogo').checked = false;
        renderEmailLogoPreview();
    };
    reader.readAsDataURL(file);
}

function copyLogoFromStatusPage() {
    document.getElementById('setNotificationLogoUrl').value = normalizedLogoUrl(document.getElementById('setStatusPageLogoUrl').value);
    document.getElementById('setNotificationUseStatusLogo').checked = true;
    renderEmailLogoPreview();
}

function clearEmailLogo() {
    document.getElementById('setNotificationLogoUrl').value = '';
    renderEmailLogoPreview();
}

function initEmailLogoUpload() {
    const input = document.getElementById('emailLogoFileInput');
    const drop = document.getElementById('emailLogoDrop');
    if (!input || !drop || input.dataset.bound === '1') return;
    input.dataset.bound = '1';
    bindLogoDropTarget(input, drop, setEmailLogoFromFile);
}

function initBrandLogoUpload() {
    const statusInput = document.getElementById('statusLogoFileInput');
    const statusDrop = document.getElementById('statusLogoDrop');
    if (statusInput && statusDrop && statusInput.dataset.bound !== '1') {
        statusInput.dataset.bound = '1';
        bindLogoDropTarget(statusInput, statusDrop, setStatusLogoFromFile);
    }
    const adminInput = document.getElementById('adminPanelLogoFileInput');
    const adminDrop = document.getElementById('adminPanelLogoDrop');
    if (adminInput && adminDrop && adminInput.dataset.bound !== '1') {
        adminInput.dataset.bound = '1';
        bindLogoDropTarget(adminInput, adminDrop, setAdminPanelLogoFromFile);
    }
}

function publishUrlForCurrentProject() {
    const custom = normalizeDomainInput(currentProjectCustomDomain);
    if (custom) {
        const proto = (window.location.protocol === 'http:' || custom === 'localhost' || custom === '127.0.0.1') ? 'http://' : 'https://';
        return proto + custom;
    }
    if (currentProjectSlug) return window.location.origin + '/p/' + currentProjectSlug;
    return window.location.origin + '/index.html';
}

function updatePublishUrlPreview() {
    const customField = document.getElementById('setCustomDomain');
    const preview = document.getElementById('publishUrlPreview');
    if (!preview) return;
    const typed = customField ? normalizeDomainInput(customField.value) : '';
    if (typed) {
        const proto = (window.location.protocol === 'http:' || typed === 'localhost' || typed === '127.0.0.1') ? 'http://' : 'https://';
        preview.textContent = proto + typed;
        return;
    }
    preview.textContent = publishUrlForCurrentProject();
}

function updateViewLink() {
    const link = document.getElementById('viewStatusLink');
    link.href = publishUrlForCurrentProject();
}

function currentProjectRecord() {
    return projects.find((p) => p.id === currentProjectId) || null;
}

function componentScopeLabel(projectId) {
    const p = projects.find((item) => item.id === projectId);
    return p ? p.name : ('Project ' + projectId);
}

function updateProjectViewTargetHint() {
    const hint = document.getElementById('projectViewTargetHint');
    if (!hint) return;
    const current = currentProjectRecord();
    const primary = projects.find((p) => p.id === projectViewConfig.primaryProjectId) || null;
    if (!projects.length || !current || !primary) {
        hint.textContent = 'Select a project to configure its view mode.';
        hint.style.color = '';
        return;
    }
    if (current.id === primary.id) {
        hint.textContent = `Editing view mode for "${current.name}".`;
        hint.style.color = '';
        return;
    }
    hint.textContent = `You are on "${current.name}", but Save will update "${primary.name}" because Project 1 is set to it.`;
    hint.style.color = '#b35b00';
}

function renderProjectViewModeControls() {
    const modeSelect = document.getElementById('projectViewModeSelect');
    const primarySelect = document.getElementById('projectPrimarySelect');
    const secondarySelect = document.getElementById('projectSecondarySelect');
    const tertiarySelect = document.getElementById('projectTertiarySelect');
    const secondaryWrap = document.getElementById('projectSecondaryWrap');
    const tertiaryWrap = document.getElementById('projectTertiaryWrap');
    if (!modeSelect || !primarySelect || !secondarySelect || !tertiarySelect || !secondaryWrap || !tertiaryWrap) return;

    if (!projects.length) {
        modeSelect.value = 'single';
        primarySelect.innerHTML = '<option value="">No projects</option>';
        secondarySelect.innerHTML = '<option value="">No projects</option>';
        tertiarySelect.innerHTML = '<option value="">No projects</option>';
        primarySelect.disabled = true;
        secondarySelect.disabled = true;
        tertiarySelect.disabled = true;
        updateProjectViewTargetHint();
        return;
    }

    const primaryId = (projectViewConfig.primaryProjectId && projects.find((p) => p.id === projectViewConfig.primaryProjectId))
        ? projectViewConfig.primaryProjectId
        : (currentProjectId || projects[0].id);
    projectViewConfig.primaryProjectId = primaryId;

    primarySelect.disabled = false;
    primarySelect.innerHTML = projects.map((project) =>
        `<option value="${project.id}">${esc(project.name)}</option>`
    ).join('');
    primarySelect.value = String(primaryId);

    const mode = ['dual', 'triad'].includes(projectViewConfig.mode) ? projectViewConfig.mode : 'single';
    projectViewConfig.mode = mode;
    modeSelect.value = mode;

    const secondaryOptions = projects
        .filter((project) => project.id !== primaryId)
        .map((project) => `<option value="${project.id}">${esc(project.name)}</option>`)
        .join('');
    secondarySelect.innerHTML = '<option value="">Disabled</option>' + secondaryOptions;
    const secondaryId = (projectViewConfig.secondaryProjectId && projects.find((project) => project.id === projectViewConfig.secondaryProjectId && project.id !== primaryId))
        ? projectViewConfig.secondaryProjectId
        : null;
    projectViewConfig.secondaryProjectId = secondaryId;
    secondarySelect.value = secondaryId ? String(secondaryId) : '';

    const tertiaryOptions = projects
        .filter((project) => project.id !== primaryId && project.id !== secondaryId)
        .map((project) => `<option value="${project.id}">${esc(project.name)}</option>`)
        .join('');
    tertiarySelect.innerHTML = '<option value="">Disabled</option>' + tertiaryOptions;
    const tertiaryId = (projectViewConfig.tertiaryProjectId && projects.find((project) => project.id === projectViewConfig.tertiaryProjectId && project.id !== primaryId && project.id !== secondaryId))
        ? projectViewConfig.tertiaryProjectId
        : null;
    projectViewConfig.tertiaryProjectId = tertiaryId;
    tertiarySelect.value = tertiaryId ? String(tertiaryId) : '';

    const isDual = mode === 'dual';
    const isTriad = mode === 'triad';
    secondaryWrap.style.display = (isDual || isTriad) ? '' : 'none';
    tertiaryWrap.style.display = isTriad ? '' : 'none';
    secondarySelect.disabled = !(isDual || isTriad);
    tertiarySelect.disabled = !isTriad;
    secondarySelect.setCustomValidity('');
    tertiarySelect.setCustomValidity('');
    updateProjectViewTargetHint();
}

function onProjectViewModeChange(value) {
    projectViewConfig.mode = value === 'triad' ? 'triad' : (value === 'dual' ? 'dual' : 'single');
    if (projectViewConfig.mode === 'single') {
        projectViewConfig.secondaryProjectId = null;
        projectViewConfig.tertiaryProjectId = null;
    }
    if (projectViewConfig.mode === 'dual') {
        projectViewConfig.tertiaryProjectId = null;
    }
    renderProjectViewModeControls();
}

async function onProjectPrimaryChange(value) {
    const primaryId = parseInt(value, 10) || null;
    if (!primaryId) return;
    projectViewConfig.primaryProjectId = primaryId;
    if (projectViewConfig.secondaryProjectId === primaryId) projectViewConfig.secondaryProjectId = null;
    if (projectViewConfig.tertiaryProjectId === primaryId) projectViewConfig.tertiaryProjectId = null;
    const settings = await api('GET', adminProjectPath(primaryId, '/settings'));
    if (settings && !settings.error) {
        projectViewConfig.mode = settings.displayMode === 'triad' ? 'triad' : (settings.displayMode === 'dual' ? 'dual' : 'single');
        projectViewConfig.secondaryProjectId = parseInt(settings.secondaryProjectId, 10) || null;
        projectViewConfig.tertiaryProjectId = parseInt(settings.tertiaryProjectId, 10) || null;
    }
    renderProjectViewModeControls();
}

function onProjectSecondaryChange(value) {
    projectViewConfig.secondaryProjectId = parseInt(value, 10) || null;
    if (projectViewConfig.tertiaryProjectId && projectViewConfig.tertiaryProjectId === projectViewConfig.secondaryProjectId) {
        projectViewConfig.tertiaryProjectId = null;
    }
    renderProjectViewModeControls();
}

function onProjectTertiaryChange(value) {
    projectViewConfig.tertiaryProjectId = parseInt(value, 10) || null;
    renderProjectViewModeControls();
}

async function saveProjectViewMode() {
    if (!requireEdit()) return;
    const modeSelect = document.getElementById('projectViewModeSelect');
    const primarySelect = document.getElementById('projectPrimarySelect');
    const secondarySelect = document.getElementById('projectSecondarySelect');
    const tertiarySelect = document.getElementById('projectTertiarySelect');
    if (!modeSelect || !primarySelect || !secondarySelect || !tertiarySelect) return;

    modeSelect.setCustomValidity('');
    primarySelect.setCustomValidity('');
    secondarySelect.setCustomValidity('');
    tertiarySelect.setCustomValidity('');

    const mode = modeSelect.value === 'triad' ? 'triad' : (modeSelect.value === 'dual' ? 'dual' : 'single');
    const primaryId = parseInt(primarySelect.value, 10) || null;
    const secondaryId = (mode === 'dual' || mode === 'triad') ? (parseInt(secondarySelect.value, 10) || null) : null;
    const tertiaryId = mode === 'triad' ? (parseInt(tertiarySelect.value, 10) || null) : null;
    if (!primaryId) {
        primarySelect.setCustomValidity('Select Project 1');
        primarySelect.reportValidity();
        primarySelect.focus();
        return;
    }
    if (mode === 'dual' && !secondaryId) {
        secondarySelect.setCustomValidity('Select Project 2 for Dual View');
        secondarySelect.reportValidity();
        secondarySelect.focus();
        toast('Select Project 2 for Dual View');
        return;
    }
    if (mode === 'dual' && primaryId === secondaryId) {
        secondarySelect.setCustomValidity('Project 2 must be different from Project 1');
        secondarySelect.reportValidity();
        secondarySelect.focus();
        return;
    }
    if (mode === 'triad' && !secondaryId) {
        secondarySelect.setCustomValidity('Select Project 2 for Triad View');
        secondarySelect.reportValidity();
        secondarySelect.focus();
        toast('Select Project 2 for Triad View');
        return;
    }
    if (mode === 'triad' && !tertiaryId) {
        tertiarySelect.setCustomValidity('Select Project 3 for Triad View');
        tertiarySelect.reportValidity();
        tertiarySelect.focus();
        toast('Select Project 3 for Triad View');
        return;
    }
    if (mode === 'triad' && primaryId === secondaryId) {
        secondarySelect.setCustomValidity('Project 2 must be different from Project 1');
        secondarySelect.reportValidity();
        secondarySelect.focus();
        return;
    }
    if (mode === 'triad' && (primaryId === tertiaryId || secondaryId === tertiaryId)) {
        tertiarySelect.setCustomValidity('Project 3 must be different from Project 1 and Project 2');
        tertiarySelect.reportValidity();
        tertiarySelect.focus();
        return;
    }

    const saved = await api('PUT', adminProjectPath(primaryId, '/settings'), {
        displayMode: mode,
        secondaryProjectId: (mode === 'dual' || mode === 'triad') ? secondaryId : null,
        tertiaryProjectId: mode === 'triad' ? tertiaryId : null
    });
    if (saved && saved.error) {
        if (saved.fieldErrors && saved.fieldErrors.secondaryProjectId) {
            secondarySelect.setCustomValidity(saved.fieldErrors.secondaryProjectId);
            secondarySelect.reportValidity();
            secondarySelect.focus();
        } else if (saved.fieldErrors && saved.fieldErrors.tertiaryProjectId) {
            tertiarySelect.setCustomValidity(saved.fieldErrors.tertiaryProjectId);
            tertiarySelect.reportValidity();
            tertiarySelect.focus();
        }
        toast(saved.error);
        return;
    }

    projectViewConfig = {
        mode: saved && saved.displayMode === 'triad' ? 'triad' : (saved && saved.displayMode === 'dual' ? 'dual' : 'single'),
        primaryProjectId: primaryId,
        secondaryProjectId: saved && ['dual', 'triad'].includes(saved.displayMode) ? (parseInt(saved.secondaryProjectId, 10) || null) : null,
        tertiaryProjectId: saved && saved.displayMode === 'triad' ? (parseInt(saved.tertiaryProjectId, 10) || null) : null
    };

    if (primaryId === currentProjectId) {
        dualDisplayMode = projectViewConfig.mode;
        dualSecondaryProjectId = projectViewConfig.secondaryProjectId;
        dualTertiaryProjectId = projectViewConfig.tertiaryProjectId;
        renderDualProjectSelectors();
        await loadComponents();
    }

    renderProjectViewModeControls();
    toast('Project view mode saved');
}

function onDisplayModeChange(value) {
    dualDisplayMode = value === 'triad' ? 'triad' : (value === 'dual' ? 'dual' : 'single');
    if (dualDisplayMode === 'single') {
        dualSecondaryProjectId = null;
        dualTertiaryProjectId = null;
    }
    if (dualDisplayMode === 'dual') dualTertiaryProjectId = null;
    renderDualProjectSelectors();
}

function componentScopeOptions() {
    const options = [{ id: currentProjectId, role: 'primary' }];
    if ((dualDisplayMode === 'dual' || dualDisplayMode === 'triad') && dualSecondaryProjectId && dualSecondaryProjectId !== currentProjectId) {
        options.push({ id: dualSecondaryProjectId, role: 'secondary' });
    }
    if (dualDisplayMode === 'triad' && dualTertiaryProjectId && dualTertiaryProjectId !== currentProjectId && dualTertiaryProjectId !== dualSecondaryProjectId) {
        options.push({ id: dualTertiaryProjectId, role: 'tertiary' });
    }
    return options;
}

function renderDualProjectSelectors() {
    const componentScopeSelect = document.getElementById('componentScopeSelect');
    const opts = componentScopeOptions();
    if (componentScopeSelect) {
        componentScopeSelect.innerHTML = opts.map((item) => {
            const roleLabel = item.role === 'primary' ? 'Primary' : (item.role === 'secondary' ? 'Secondary' : 'Tertiary');
            return `<option value="${item.id}">${esc(componentScopeLabel(item.id))} (${roleLabel})</option>`;
        }).join('');
        if (!opts.find((item) => item.id === activeComponentProjectId)) {
            activeComponentProjectId = currentProjectId;
        }
        componentScopeSelect.value = String(activeComponentProjectId || currentProjectId || '');
        componentScopeSelect.disabled = opts.length <= 1;
    }
    const note = document.getElementById('componentScopeNote');
    if (note) {
        const active = opts.find((item) => item.id === (activeComponentProjectId || currentProjectId));
        const role = active ? active.role : 'primary';
        note.textContent = `Components are managed for ${componentScopeLabel(activeComponentProjectId || currentProjectId)} (${role}).`;
    }
}

async function onComponentScopeChange(value) {
    const parsed = parseInt(value, 10);
    if (!parsed || parsed === activeComponentProjectId) return;
    activeComponentProjectId = parsed;
    renderDualProjectSelectors();
    await loadComponents();
}

async function loadProjectsList() {
    projects = await api('GET', '/api/v1/admin/projects');
    const selected = parseInt(localStorage.getItem('statusPageProjectId') || '0', 10);
    if (!projects.length) {
        currentProjectId = null;
        currentProjectSlug = '';
        currentProjectCustomDomain = '';
        activeComponentProjectId = null;
        projectSelect.innerHTML = '<option value="">No projects</option>';
        const componentScopeSelect = document.getElementById('componentScopeSelect');
        if (componentScopeSelect) componentScopeSelect.innerHTML = '<option value="">Primary</option>';
        updateViewLink();
        updatePublishUrlPreview();
        projectViewConfig = { mode: 'single', primaryProjectId: null, secondaryProjectId: null, tertiaryProjectId: null };
        renderProjectViewModeControls();
        renderProjects();
        return;
    }
    if (!currentProjectId) {
        currentProjectId = projects.find(p => p.id === selected) ? selected : projects[0].id;
    }
    projectSelect.innerHTML = projects.map(p =>
        `<option value="${p.id}" ${p.id === currentProjectId ? 'selected' : ''}>${esc(p.name)}</option>`
    ).join('');
    const current = projects.find(p => p.id === currentProjectId);
    currentProjectSlug = current ? current.slug : '';
    currentProjectCustomDomain = current ? normalizeDomainInput(current.customDomain || '') : '';
    if (!activeComponentProjectId) activeComponentProjectId = currentProjectId;
    updateViewLink();
    updatePublishUrlPreview();
    renderDualProjectSelectors();
    if (!projectViewConfig.primaryProjectId || !projects.find((p) => p.id === projectViewConfig.primaryProjectId)) {
        projectViewConfig.primaryProjectId = currentProjectId;
    }
    renderProjectViewModeControls();
    renderProjects();
}

projectSelect.addEventListener('change', async (e) => {
    const id = parseInt(e.target.value, 10);
    if (!id || id === currentProjectId) return;
    await setCurrentProject(id);
});

async function setCurrentProject(id) {
    currentProjectId = id;
    activeComponentProjectId = id;
    dualDisplayMode = 'single';
    dualSecondaryProjectId = null;
    dualTertiaryProjectId = null;
    localStorage.setItem('statusPageProjectId', String(id));
    const current = projects.find(p => p.id === currentProjectId);
    currentProjectSlug = current ? current.slug : '';
    currentProjectCustomDomain = current ? normalizeDomainInput(current.customDomain || '') : '';
    updateViewLink();
    updatePublishUrlPreview();
    renderDualProjectSelectors();
    allComponents = [];
    await reloadAll();
}

function renderProjects() {
    const container = document.getElementById('projectsList');
    if (!projects.length) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">&#128193;</div><p>No projects yet</p></div>';
        return;
    }
    container.innerHTML = `<div class="card"><div class="card-body">
        <div class="table-wrap"><table class="table"><thead><tr><th>Name</th><th>Slug</th><th>Domain</th><th>Created</th><th style="text-align:right">Actions</th></tr></thead><tbody>
        ${projects.map(p => `
            <tr>
                <td><strong>${esc(p.name)}</strong></td>
                <td style="color:#7a869a">${esc(p.slug)}</td>
                <td style="color:#7a869a">${esc(p.customDomain || '-')}</td>
                <td style="color:#7a869a">${new Date(p.createdAt).toLocaleDateString()}</td>
                <td class="actions">
                    ${canEdit() ? `<button class="btn btn-sm btn-secondary" onclick="openProjectModal(${p.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProject(${p.id})">Delete</button>` : ''}
                </td>
            </tr>
        `).join('')}
        </tbody></table></div>
    </div></div>`;
}

function openProjectModal(id) {
    if (!requireEdit()) return;
    const project = projects.find(p => p.id === id);
    document.getElementById('projectModalTitle').textContent = project ? 'Edit Project' : 'New Project';
    document.getElementById('projName').value = project ? project.name : '';
    document.getElementById('projSlug').value = project ? project.slug : '';
    document.getElementById('projId').value = project ? project.id : '';
    openModal('projectModal');
}

async function saveProject() {
    if (!requireEdit()) return;
    const id = document.getElementById('projId').value;
    const name = document.getElementById('projName').value.trim();
    const slug = document.getElementById('projSlug').value.trim();
    if (!name) return;
    if (id) {
        const payload = { name };
        if (slug) payload.slug = slug;
        await api('PUT', '/api/v1/admin/projects/' + id, payload);
        toast('Project updated');
    } else {
        const payload = { name };
        if (slug) payload.slug = slug;
        const created = await api('POST', '/api/v1/admin/projects', payload);
        toast('Project created');
        if (created && created.id) currentProjectId = created.id;
    }
    closeModal('projectModal');
    await loadProjectsList();
    if (currentProjectId) await setCurrentProject(currentProjectId);
}

async function deleteProject(id) {
    if (!requireEdit()) return;
    if (!confirm('Delete this project?')) return;
    await api('DELETE', '/api/v1/admin/projects/' + id);
    toast('Project deleted');
    if (currentProjectId === id) currentProjectId = null;
    await loadProjectsList();
    if (currentProjectId) await setCurrentProject(currentProjectId);
}

async function reloadAll() {
    if (!currentProjectId) return;
    await loadComponents();
    await Promise.all([loadDashboard(), loadIncidents(), loadMaintenances(), loadSubscribers(), loadSettings()]);
}

// ── Toast ─────────────────────────────────────────────────────────────────
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function clearFieldErrors(fieldMap) {
    Object.values(fieldMap || {}).forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.setCustomValidity('');
    });
}

function applyFieldErrors(fieldErrors, fieldMap) {
    if (!fieldErrors || typeof fieldErrors !== 'object') return false;
    let firstInvalid = null;
    for (const [key, id] of Object.entries(fieldMap || {})) {
        const el = document.getElementById(id);
        if (!el) continue;
        const msg = fieldErrors[key] ? String(fieldErrors[key]) : '';
        el.setCustomValidity(msg);
        if (msg && !firstInvalid) firstInvalid = el;
    }
    if (!firstInvalid) return false;
    firstInvalid.reportValidity();
    firstInvalid.focus();
    return true;
}

function summarizeFieldErrors(fieldErrors) {
    if (!fieldErrors || typeof fieldErrors !== 'object') return '';
    const items = Object.values(fieldErrors).map(v => String(v || '').trim()).filter(Boolean);
    return items.join(' | ');
}

// ── Tabs ──────────────────────────────────────────────────────────────────
function showTab(name) {
    if (isTabHiddenForCurrentUser(name)) return;
    closeSidebar(); // close mobile nav on tab switch
    document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const titles = { dashboard: 'Dashboard', components: 'Components', incidents: 'Incidents', maintenance: 'Scheduled Maintenance', subscribers: 'Subscribers', projects: 'Projects', users: 'Users', settings: 'Settings' };
    document.getElementById('pageTitle').textContent = titles[name] || name;
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(n => { if (n.textContent.trim().toLowerCase().includes(name === 'dashboard' ? 'overview' : name)) n.classList.add('active'); });
    // Refresh data
    if (name === 'dashboard') loadDashboard();
    if (name === 'components') loadComponents();
    if (name === 'incidents') loadIncidents();
    if (name === 'maintenance') loadMaintenances();
    if (name === 'subscribers') loadSubscribers();
    if (name === 'projects') loadProjectsList();
    if (name === 'users') loadUsers();
    if (name === 'settings') loadSettings();
}

// ── Modals ────────────────────────────────────────────────────────────────
let _modalPrevFocus = null;
function openModal(id) {
    _modalPrevFocus = document.activeElement;
    const modal = document.getElementById(id);
    modal.classList.add('show');
    // Focus first focusable element inside modal
    const focusable = modal.querySelector('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
    if (focusable) setTimeout(() => focusable.focus(), 50);
}
function closeModal(id) {
    document.getElementById(id).classList.remove('show');
    if (_modalPrevFocus) { _modalPrevFocus.focus(); _modalPrevFocus = null; }
}

// Close modals on Escape key; close sidebar on Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openOverlay = document.querySelector('.modal-overlay.show');
        if (openOverlay) { closeModal(openOverlay.id); return; }
        closeSidebar();
    }
});

// Trap focus inside open modal
document.addEventListener('keydown', function(e) {
    if (e.key !== 'Tab') return;
    const openOverlay = document.querySelector('.modal-overlay.show');
    if (!openOverlay) return;
    const focusables = openOverlay.querySelectorAll('input,select,textarea,button,a,[tabindex]:not([tabindex="-1"])');
    if (!focusables.length) return;
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
});

function requireEdit() {
    if (!canEdit()) { toast('Viewer access: changes are disabled.'); return false; }
    return true;
}

// ── Dashboard ─────────────────────────────────────────────────────────────
async function loadDashboard() {
    const stats = await api('GET', projectPath('/stats'));
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat"><div class="stat-label">Total Components</div><div class="stat-val blue">${stats.totalComponents}</div></div>
        <div class="stat"><div class="stat-label">Operational</div><div class="stat-val green">${stats.operationalComponents}</div></div>
        <div class="stat"><div class="stat-label">Active Incidents</div><div class="stat-val ${stats.activeIncidents > 0 ? 'red' : 'green'}">${stats.activeIncidents}</div></div>
        <div class="stat"><div class="stat-label">Scheduled Maintenance</div><div class="stat-val yellow">${stats.scheduledMaintenances}</div></div>
        <div class="stat"><div class="stat-label">Subscribers</div><div class="stat-val blue">${stats.totalSubscribers}</div></div>
    `;
    const incidents = await api('GET', projectPath('/incidents'));
    const recent = incidents.slice(0, 5);
    if (recent.length === 0) {
        document.getElementById('recentIncidents').innerHTML = '<div class="empty"><div class="empty-icon">&#10003;</div><p>No incidents</p></div>';
    } else {
        document.getElementById('recentIncidents').innerHTML = recent.map(i =>
            `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f4f5f7">
                <div><strong style="font-size:14px">${esc(i.title)}</strong><br><span style="font-size:12px;color:#7a869a">${new Date(i.createdAt).toLocaleString()}</span></div>
                <span class="badge ${i.status}"><span class="badge-dot"></span>${i.status}</span>
            </div>`
        ).join('');
    }
}

// ── Components ────────────────────────────────────────────────────────────
let allComponents = [];
let expandedNodes = new Set();

async function loadComponents() {
    renderDualProjectSelectors();
    allComponents = await api('GET', componentProjectPath('/components'));
    const scopeSettings = await api('GET', componentProjectPath('/settings'));
    const uptimeSelect = document.getElementById('showUptime');
    if (uptimeSelect && scopeSettings && !scopeSettings.error) {
        uptimeSelect.value = String(scopeSettings.showUptime !== false);
    }
    renderComponents();
}

function renderComponents() {
    const container = document.getElementById('componentsList');
    const tree = buildTree(allComponents);
    if (!tree.length) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">&#9881;</div><p>No components yet. Create one to get started!</p></div>';
        return;
    }
    container.innerHTML = `<div class="card"><div class="card-body">${tree.map(n => renderTreeRow(n, 0)).join('')}</div></div>`;
    bindTreeDnD();
}

function buildTree(list) {
    const map = new Map();
    for (const c of list) map.set(c.id, { ...c, children: [] });
    const roots = [];
    for (const c of map.values()) {
        if (c.parentId && map.has(c.parentId)) map.get(c.parentId).children.push(c);
        else roots.push(c);
    }
    const sortTree = (nodes) => {
        nodes.sort((a, b) => (a.order || 0) - (b.order || 0));
        for (const n of nodes) {
            if (n.children && n.children.length) sortTree(n.children);
        }
    };
    sortTree(roots);
    return roots;
}

function renderTreeRow(node, depth) {
    const indent = depth * 18;
    const hasChildren = node.children && node.children.length;
    const expanded = expandedNodes.has(node.id);
    const toggle = hasChildren ? `<span class="tree-toggle" onclick="toggleNode(${node.id});event.stopPropagation()">${expanded ? '&#9660;' : '&#9654;'}</span>` : '<span class="tree-toggle"></span>';
    return `<div class="tree-node ${expanded ? '' : 'tree-collapsed'}">
        <div class="tree-row" data-id="${node.id}" data-parent="${node.parentId || ''}" draggable="true">
            <div class="tree-name" style="padding-left:${indent}px">
                ${toggle}<strong>${esc(node.name)}</strong>
                <div style="font-size:12px;color:#7a869a">${esc(node.description || '')}</div>
            </div>
            <span class="badge ${node.status}"><span class="badge-dot"></span>${statusLabel(node.status)}</span>
            ${canEdit() ? `<div class="actions">
                <button class="btn btn-sm btn-secondary" onclick="editComponent(${node.id})">Edit</button>
                <button class="btn btn-sm btn-secondary" onclick="duplicateComponent(${node.id})">Duplicate</button>
                <button class="btn btn-sm btn-danger" onclick="deleteComponent(${node.id})">Delete</button>
            </div>` : ''}
        </div>
        ${hasChildren ? `<div class="tree-children">${node.children.map(c => renderTreeRow(c, depth + 1)).join('')}</div>` : ''}
    </div>`;
}

function toggleNode(id) {
    if (expandedNodes.has(id)) expandedNodes.delete(id);
    else expandedNodes.add(id);
    renderComponents();
}

let dragInfo = null;
function bindTreeDnD() {
    document.querySelectorAll('#componentsList .tree-row').forEach(row => {
        row.addEventListener('dragstart', onDragStart);
        row.addEventListener('dragover', onDragOver);
        row.addEventListener('drop', onDrop);
        row.addEventListener('dragend', onDragEnd);
    });
}

function onDragStart(e) {
    const row = e.currentTarget;
    dragInfo = {
        id: parseInt(row.dataset.id, 10),
        parentId: row.dataset.parent ? parseInt(row.dataset.parent, 10) : null
    };
    row.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function onDragOver(e) {
    if (!dragInfo) return;
    const row = e.currentTarget;
    const targetParent = row.dataset.parent ? parseInt(row.dataset.parent, 10) : null;
    if (targetParent !== dragInfo.parentId) return;
    e.preventDefault();
    row.classList.add('drag-over');
    e.dataTransfer.dropEffect = 'move';
}

async function onDrop(e) {
    if (!dragInfo) return;
    e.preventDefault();
    const row = e.currentTarget;
    row.classList.remove('drag-over');
    const targetId = parseInt(row.dataset.id, 10);
    if (!targetId || targetId === dragInfo.id) return;
    const parentId = row.dataset.parent ? parseInt(row.dataset.parent, 10) : null;
    if (parentId !== dragInfo.parentId) return;
    const siblings = allComponents
        .filter(c => (c.parentId || null) === parentId)
        .sort((a, b) => (a.order || 0) - (b.order || 0));
    const ids = siblings.map(c => c.id).filter(id => id !== dragInfo.id);
    const targetIndex = ids.indexOf(targetId);
    if (targetIndex < 0) return;
    ids.splice(targetIndex, 0, dragInfo.id);
    ids.forEach((id, idx) => {
        const comp = allComponents.find(c => c.id === id);
        if (comp) comp.order = idx;
    });
    await api('POST', componentProjectPath('/components/reorder'), { parentId, orderedIds: ids });
    renderComponents();
}

function onDragEnd() {
    document.querySelectorAll('#componentsList .tree-row.drag-over').forEach(r => r.classList.remove('drag-over'));
    document.querySelectorAll('#componentsList .tree-row.dragging').forEach(r => r.classList.remove('dragging'));
    dragInfo = null;
}

function openComponentModal(comp) {
    if (!requireEdit()) return;
    document.getElementById('componentModalTitle').textContent = comp ? 'Edit Component' : 'Add Component';
    document.getElementById('compName').value = comp ? comp.name : '';
    document.getElementById('compDesc').value = comp ? (comp.description || '') : '';
    document.getElementById('compStatus').value = comp ? comp.status : 'operational';
    document.getElementById('compId').value = comp ? comp.id : '';
    const options = allComponents
        .filter(c => !comp || c.id !== comp.id)
        .map(c => `<option value="${c.id}" ${comp && comp.parentId === c.id ? 'selected' : ''}>${esc(c.name)}</option>`)
        .join('');
    document.getElementById('compParent').innerHTML = '<option value="">No parent</option>' + options;
    openModal('componentModal');
}

function editComponent(id) {
    const comp = allComponents.find(c => c.id === id);
    if (comp) openComponentModal(comp);
}

async function duplicateComponent(id) {
    if (!requireEdit()) return;
    const comp = allComponents.find(c => c.id === id);
    if (!comp) return;
    const data = {
        name: comp.name + ' (Copy)',
        description: comp.description || '',
        parentId: comp.parentId || null,
        status: comp.status || 'operational'
    };
    await api('POST', componentProjectPath('/components'), data);
    toast('Component duplicated');
    loadComponents();
}

async function saveComponent() {
    if (!requireEdit()) return;
    const id = document.getElementById('compId').value;
    const data = {
        name: document.getElementById('compName').value,
        description: document.getElementById('compDesc').value,
        parentId: parseInt(document.getElementById('compParent').value) || null,
        status: document.getElementById('compStatus').value
    };
    if (!data.name) return;
    if (id) await api('PUT', componentProjectPath('/components/' + id), data);
    else await api('POST', componentProjectPath('/components'), data);
    closeModal('componentModal');
    toast(id ? 'Component updated' : 'Component created');
    loadComponents();
}

async function deleteComponent(id) {
    if (!requireEdit()) return;
    if (!confirm('Delete this component?')) return;
    await api('DELETE', componentProjectPath('/components/' + id));
    toast('Component deleted');
    loadComponents();
}


// ── Incidents ─────────────────────────────────────────────────────────────
async function loadIncidents() {
    allComponents = await api('GET', projectPath('/components'));
    const [incidentResponse, templateResponse] = await Promise.all([
        api('GET', projectPath('/incidents')),
        api('GET', projectPath('/incident-templates'))
    ]);
    const incidents = Array.isArray(incidentResponse) ? incidentResponse : [];
    const templates = Array.isArray(templateResponse) ? templateResponse : [];
    window.__incidentTemplateCache = templates;
    renderIncidentTemplates(templates);
    const container = document.getElementById('incidentsList');
    if (incidents.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">&#10003;</div><p>No incidents reported</p></div>';
        return;
    }
    container.innerHTML = incidents.map(inc => {
        const affected = (inc.affectedComponents || []).map(id => {
            const c = allComponents.find(x => x.id === id);
            return c ? c.name : 'Unknown';
        }).join(', ');
        const updates = [...(inc.updates || [])].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        return `<div class="card">
            <div class="card-head">
                <div><h3>${esc(inc.title)}</h3><div style="font-size:12px;color:#7a869a;margin-top:2px">${affected ? 'Affects: ' + esc(affected) : ''} &bull; ${new Date(inc.createdAt).toLocaleString()}</div></div>
                <div style="display:flex;gap:6px;align-items:center">
                    <span class="badge ${inc.status}"><span class="badge-dot"></span>${statusLabel(inc.status)}</span>
                    ${canEdit() && inc.status !== 'resolved' ? `<button class="btn btn-sm btn-warning" onclick="openUpdateModal(${inc.id},'${inc.status}')">Update</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-danger" onclick="deleteIncident(${inc.id})">Delete</button>` : ''}
                </div>
            </div>
            <div class="card-body">
                <div class="timeline">${updates.map(u => `
                    <div class="timeline-item">
                        <div class="timeline-dot ${u.status}"></div>
                        <div class="timeline-status" style="color:inherit">${statusLabel(u.status)}</div>
                        <div class="timeline-msg">${esc(u.message)}</div>
                        <div class="timeline-time">${new Date(u.createdAt).toLocaleString()}</div>
                    </div>`).join('')}
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderIncidentTemplates(templates) {
    const container = document.getElementById('incidentTemplatesList');
    if (!container) return;
    const list = Array.isArray(templates) ? templates : [];
    if (list.length === 0) {
        container.innerHTML = '<div class="empty" style="padding:18px 12px"><div class="empty-icon">&#128196;</div><p>No templates yet. Save a template to reuse incident details quickly.</p></div>';
        return;
    }
    container.innerHTML = list.map((template) => {
        const affected = (template.affectedComponents || []).map((id) => {
            const component = allComponents.find((item) => item.id === id);
            return component ? component.name : null;
        }).filter(Boolean).join(', ');
        return `<div style="border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                <div style="min-width:0">
                    <div style="font-weight:600;font-size:14px;color:#172b4d">${esc(template.name || 'Template')}</div>
                    <div style="font-size:12px;color:#42526e;margin-top:2px">${esc(template.title || '')}</div>
                    <div style="font-size:12px;color:#7a869a;margin-top:2px">Status: ${esc(statusLabel(template.status || 'investigating'))} &bull; Impact: ${esc(statusLabel(template.impact || 'minor'))}${affected ? ' &bull; Components: ' + esc(affected) : ''}</div>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
                    ${canEdit() ? `<button class="btn btn-sm btn-primary" onclick="useIncidentTemplate(${template.id})">Use</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-secondary" onclick="openIncidentTemplateModal(${template.id})">Edit</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-danger" onclick="deleteIncidentTemplate(${template.id})">Delete</button>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}

function openIncidentTemplateModal(id) {
    if (!requireEdit()) return;
    const template = (typeof id === 'number') ? ((window.__incidentTemplateCache || []).find((item) => item.id === id)) : null;
    document.getElementById('incidentTemplateModalTitle').textContent = template ? 'Edit Incident Template' : 'New Incident Template';
    document.getElementById('incidentTemplateName').value = template ? (template.name || '') : '';
    document.getElementById('incidentTemplateTitle').value = template ? (template.title || '') : '';
    document.getElementById('incidentTemplateStatus').value = template ? (template.status || 'investigating') : 'investigating';
    document.getElementById('incidentTemplateImpact').value = template ? (template.impact || 'minor') : 'minor';
    document.getElementById('incidentTemplateMessage').value = template ? (template.message || '') : '';
    document.getElementById('incidentTemplateId').value = template ? template.id : '';
    clearFieldErrors({ name: 'incidentTemplateName', title: 'incidentTemplateTitle', message: 'incidentTemplateMessage' });
    renderComponentChecks('incidentTemplateComponents', template ? (template.affectedComponents || []) : []);
    openModal('incidentTemplateModal');
}

async function saveIncidentTemplate() {
    if (!requireEdit()) return;
    const templateId = document.getElementById('incidentTemplateId').value;
    const form = document.getElementById('incidentTemplateForm');
    const nameEl = document.getElementById('incidentTemplateName');
    const titleEl = document.getElementById('incidentTemplateTitle');
    const messageEl = document.getElementById('incidentTemplateMessage');
    clearFieldErrors({ name: 'incidentTemplateName', title: 'incidentTemplateTitle', message: 'incidentTemplateMessage' });

    const name = String(nameEl.value || '').trim();
    const title = String(titleEl.value || '').trim();
    const message = String(messageEl.value || '').trim();
    if (!name) nameEl.setCustomValidity('Template name is required');
    if (!title) titleEl.setCustomValidity('Incident title is required');
    if (!message) messageEl.setCustomValidity('Default message is required');
    if (!form.checkValidity()) {
        form.reportValidity();
        const required = [];
        if (!name) required.push('Template Name');
        if (!title) required.push('Incident Title');
        if (!message) required.push('Message');
        toast('Required fields: ' + required.join(', '));
        return;
    }

    const data = {
        name,
        title,
        status: document.getElementById('incidentTemplateStatus').value,
        impact: document.getElementById('incidentTemplateImpact').value,
        message,
        affectedComponents: [...document.querySelectorAll('#incidentTemplateComponents input:checked')].map((input) => parseInt(input.value, 10))
    };
    try {
        const result = templateId
            ? await api('PUT', projectPath('/incident-templates/' + templateId), data)
            : await api('POST', projectPath('/incident-templates'), data);
        if (result && result.error) {
            const mapped = applyFieldErrors(result.fieldErrors, { name: 'incidentTemplateName', title: 'incidentTemplateTitle', message: 'incidentTemplateMessage' });
            toast(mapped ? (summarizeFieldErrors(result.fieldErrors) || 'Please complete required fields') : result.error);
            return;
        }
        closeModal('incidentTemplateModal');
        toast(templateId ? 'Template updated' : 'Template created');
        loadIncidents();
    } catch (err) {
        toast(err && err.message ? err.message : 'Failed to save incident template');
    }
}

async function deleteIncidentTemplate(id) {
    if (!requireEdit()) return;
    if (!confirm('Delete this incident template?')) return;
    const result = await api('DELETE', projectPath('/incident-templates/' + id));
    if (result && result.error) {
        toast(result.error);
        return;
    }
    toast('Template deleted');
    loadIncidents();
}

function useIncidentTemplate(id) {
    if (!requireEdit()) return;
    const template = (window.__incidentTemplateCache || []).find((item) => item.id === id);
    if (!template) {
        toast('Template not found');
        return;
    }
    openIncidentModal();
    document.getElementById('incTitle').value = template.title || '';
    document.getElementById('incStatus').value = template.status || 'investigating';
    document.getElementById('incImpact').value = template.impact || 'minor';
    document.getElementById('incMessage').value = template.message || '';
    renderComponentChecks('incComponents', template.affectedComponents || []);
}

function openIncidentModal() {
    if (!requireEdit()) return;
    document.getElementById('incTitle').value = '';
    document.getElementById('incStatus').value = 'investigating';
    document.getElementById('incImpact').value = 'minor';
    document.getElementById('incMessage').value = '';
    clearFieldErrors({ title: 'incTitle', message: 'incMessage' });
    renderComponentChecks('incComponents');
    openModal('incidentModal');
}

function renderComponentChecks(containerId, selectedIds) {
    const selected = new Set(selectedIds || []);
    document.getElementById(containerId).innerHTML = allComponents.map(c =>
        `<label class="check-item"><input type="checkbox" value="${c.id}" ${selected.has(c.id) ? 'checked' : ''}> ${esc(c.name)}</label>`
    ).join('');
}

async function saveIncident() {
    if (!requireEdit()) return;
    const form = document.getElementById('incidentForm');
    const titleEl = document.getElementById('incTitle');
    const messageEl = document.getElementById('incMessage');
    clearFieldErrors({ title: 'incTitle', message: 'incMessage' });
    const title = String(titleEl.value || '').trim();
    const message = String(messageEl.value || '').trim();
    if (!title) titleEl.setCustomValidity('Title is required');
    if (!message) messageEl.setCustomValidity('Message is required');
    if (!form.checkValidity()) {
        form.reportValidity();
        const required = [];
        if (!title) required.push('Title');
        if (!message) required.push('Message');
        toast('Required fields: ' + required.join(', '));
        return;
    }

    const data = {
        title,
        status: document.getElementById('incStatus').value,
        impact: document.getElementById('incImpact').value,
        message,
        affectedComponents: [...document.querySelectorAll('#incComponents input:checked')].map(i => parseInt(i.value))
    };
    try {
        const result = await api('POST', projectPath('/incidents'), data);
        if (result && result.error) {
            const mapped = applyFieldErrors(result.fieldErrors, { title: 'incTitle', message: 'incMessage' });
            toast(mapped ? (summarizeFieldErrors(result.fieldErrors) || 'Please complete required fields') : result.error);
            return;
        }
        closeModal('incidentModal');
        toast('Incident created');
        loadIncidents();
        loadDashboard();
    } catch (err) {
        toast(err && err.message ? err.message : 'Failed to create incident');
    }
}

function openUpdateModal(incId, currentStatus) {
    if (!requireEdit()) return;
    document.getElementById('updIncidentId').value = incId;
    document.getElementById('updStatus').value = currentStatus;
    document.getElementById('updMessage').value = '';
    openModal('updateModal');
}

async function postIncidentUpdate() {
    if (!requireEdit()) return;
    const incId = document.getElementById('updIncidentId').value;
    const messageEl = document.getElementById('updMessage');
    const message = String(messageEl.value || '').trim();
    messageEl.setCustomValidity(message ? '' : 'Message is required');
    if (!message) {
        messageEl.reportValidity();
        toast('Required fields: Message');
        return;
    }
    const data = { status: document.getElementById('updStatus').value, message };
    try {
        const result = await api('POST', projectPath('/incidents/' + incId + '/updates'), data);
        if (result && result.error) {
            toast(result.error || 'Failed to update incident');
            return;
        }
        closeModal('updateModal');
        toast('Incident updated');
        loadIncidents();
        loadDashboard();
    } catch (err) {
        toast(err && err.message ? err.message : 'Failed to update incident');
    }
}

async function deleteIncident(id) {
    if (!requireEdit()) return;
    if (!confirm('Delete this incident?')) return;
    await api('DELETE', projectPath('/incidents/' + id));
    toast('Incident deleted');
    loadIncidents();
    loadDashboard();
}

// ── Maintenance ───────────────────────────────────────────────────────────
async function loadMaintenances() {
    allComponents = await api('GET', projectPath('/components'));
    const [maintenanceResponse, templateResponse] = await Promise.all([
        api('GET', projectPath('/maintenances')),
        api('GET', projectPath('/maintenance-templates'))
    ]);
    const list = Array.isArray(maintenanceResponse) ? maintenanceResponse : [];
    const templates = Array.isArray(templateResponse) ? templateResponse : [];
    window.__maintenanceCache = list;
    window.__maintenanceTemplateCache = templates;
    renderMaintenanceTemplates(templates);
    const container = document.getElementById('maintenanceList');
    if (list.length === 0) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">&#128736;</div><p>No scheduled maintenances</p></div>';
        return;
    }
    container.innerHTML = list.map(m => {
        const affected = (m.affectedComponents || []).map(id => { const c = allComponents.find(x => x.id === id); return c ? c.name : 'Unknown'; }).join(', ');
        return `<div class="card">
            <div class="card-head">
                <div><h3>${esc(m.title)}</h3><div style="font-size:12px;color:#7a869a;margin-top:2px">${new Date(m.scheduledStart).toLocaleString()} - ${new Date(m.scheduledEnd).toLocaleString()}${affected ? ' &bull; ' + esc(affected) : ''}</div></div>
                <div style="display:flex;gap:6px;align-items:center">
                    <span class="badge ${m.status}"><span class="badge-dot"></span>${statusLabel(m.status)}</span>
                    ${canEdit() ? `<button class="btn btn-sm btn-secondary" onclick="openMaintenanceModal(${m.id})">Edit</button>` : ''}
                    ${canEdit() && m.status === 'scheduled' ? `<button class="btn btn-sm btn-warning" onclick="startMaintenance(${m.id})">Start</button>` : ''}
                    ${canEdit() && m.status === 'in_progress' ? `<button class="btn btn-sm btn-success" onclick="completeMaintenance(${m.id})">Complete</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-danger" onclick="deleteMaintenance(${m.id})">Delete</button>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderMaintenanceTemplates(templates) {
    const container = document.getElementById('maintenanceTemplatesList');
    if (!container) return;
    const list = Array.isArray(templates) ? templates : [];
    if (list.length === 0) {
        container.innerHTML = '<div class="empty" style="padding:18px 12px"><div class="empty-icon">&#128196;</div><p>No templates yet. Save a template to reuse maintenance details quickly.</p></div>';
        return;
    }
    container.innerHTML = list.map((template) => {
        const affected = (template.affectedComponents || []).map((id) => {
            const component = allComponents.find((item) => item.id === id);
            return component ? component.name : null;
        }).filter(Boolean).join(', ');
        const duration = parseInt(template.defaultDurationMinutes, 10);
        const durationText = Number.isInteger(duration) ? `${duration} min` : '60 min';
        return `<div style="border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
                <div style="min-width:0">
                    <div style="font-weight:600;font-size:14px;color:#172b4d">${esc(template.name || 'Template')}</div>
                    <div style="font-size:12px;color:#42526e;margin-top:2px">${esc(template.title || '')}</div>
                    <div style="font-size:12px;color:#7a869a;margin-top:2px">Duration: ${esc(durationText)}${affected ? ' &bull; Components: ' + esc(affected) : ''}</div>
                </div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
                    ${canEdit() ? `<button class="btn btn-sm btn-primary" onclick="useMaintenanceTemplate(${template.id})">Use</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-secondary" onclick="openMaintenanceTemplateModal(${template.id})">Edit</button>` : ''}
                    ${canEdit() ? `<button class="btn btn-sm btn-danger" onclick="deleteMaintenanceTemplate(${template.id})">Delete</button>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}

function openMaintenanceTemplateModal(id) {
    if (!requireEdit()) return;
    const template = (typeof id === 'number') ? ((window.__maintenanceTemplateCache || []).find((item) => item.id === id)) : null;
    document.getElementById('maintenanceTemplateModalTitle').textContent = template ? 'Edit Maintenance Template' : 'New Maintenance Template';
    document.getElementById('maintenanceTemplateName').value = template ? (template.name || '') : '';
    document.getElementById('maintenanceTemplateTitle').value = template ? (template.title || '') : '';
    document.getElementById('maintenanceTemplateMessage').value = template ? (template.message || '') : '';
    document.getElementById('maintenanceTemplateDuration').value = template ? (template.defaultDurationMinutes || 60) : 60;
    document.getElementById('maintenanceTemplateId').value = template ? template.id : '';
    clearFieldErrors({
        name: 'maintenanceTemplateName',
        title: 'maintenanceTemplateTitle',
        defaultDurationMinutes: 'maintenanceTemplateDuration'
    });
    renderComponentChecks('maintenanceTemplateComponents', template ? (template.affectedComponents || []) : []);
    openModal('maintenanceTemplateModal');
}

async function saveMaintenanceTemplate() {
    if (!requireEdit()) return;
    const templateId = document.getElementById('maintenanceTemplateId').value;
    const form = document.getElementById('maintenanceTemplateForm');
    const nameEl = document.getElementById('maintenanceTemplateName');
    const titleEl = document.getElementById('maintenanceTemplateTitle');
    const durationEl = document.getElementById('maintenanceTemplateDuration');
    clearFieldErrors({
        name: 'maintenanceTemplateName',
        title: 'maintenanceTemplateTitle',
        defaultDurationMinutes: 'maintenanceTemplateDuration'
    });

    const name = String(nameEl.value || '').trim();
    const title = String(titleEl.value || '').trim();
    const durationRaw = String(durationEl.value || '').trim();
    if (!name) nameEl.setCustomValidity('Template name is required');
    if (!title) titleEl.setCustomValidity('Maintenance title is required');
    if (!durationRaw) durationEl.setCustomValidity('Duration is required');
    const duration = parseInt(durationRaw, 10);
    if (durationRaw && (!Number.isInteger(duration) || duration < 5 || duration > 10080)) {
        durationEl.setCustomValidity('Duration must be between 5 and 10080 minutes');
    }
    if (!form.checkValidity()) {
        form.reportValidity();
        const required = [];
        if (!name) required.push('Template Name');
        if (!title) required.push('Maintenance Title');
        if (!durationRaw) required.push('Duration');
        toast(required.length ? ('Required fields: ' + required.join(', ')) : 'Please fix invalid template fields');
        return;
    }

    const data = {
        name,
        title,
        message: String(document.getElementById('maintenanceTemplateMessage').value || '').trim(),
        defaultDurationMinutes: duration,
        affectedComponents: [...document.querySelectorAll('#maintenanceTemplateComponents input:checked')].map((input) => parseInt(input.value, 10))
    };
    try {
        const result = templateId
            ? await api('PUT', projectPath('/maintenance-templates/' + templateId), data)
            : await api('POST', projectPath('/maintenance-templates'), data);
        if (result && result.error) {
            const mapped = applyFieldErrors(result.fieldErrors, {
                name: 'maintenanceTemplateName',
                title: 'maintenanceTemplateTitle',
                defaultDurationMinutes: 'maintenanceTemplateDuration'
            });
            toast(mapped ? (summarizeFieldErrors(result.fieldErrors) || 'Please complete required fields') : result.error);
            return;
        }
        closeModal('maintenanceTemplateModal');
        toast(templateId ? 'Template updated' : 'Template created');
        loadMaintenances();
    } catch (err) {
        toast(err && err.message ? err.message : 'Failed to save maintenance template');
    }
}

async function deleteMaintenanceTemplate(id) {
    if (!requireEdit()) return;
    if (!confirm('Delete this maintenance template?')) return;
    const result = await api('DELETE', projectPath('/maintenance-templates/' + id));
    if (result && result.error) {
        toast(result.error);
        return;
    }
    toast('Template deleted');
    loadMaintenances();
}

function useMaintenanceTemplate(id) {
    if (!requireEdit()) return;
    const template = (window.__maintenanceTemplateCache || []).find((item) => item.id === id);
    if (!template) {
        toast('Template not found');
        return;
    }
    openMaintenanceModal();
    const start = new Date();
    const durationCandidate = parseInt(template.defaultDurationMinutes, 10);
    const durationMinutes = Number.isInteger(durationCandidate) ? Math.max(5, Math.min(10080, durationCandidate)) : 60;
    const end = new Date(start.getTime() + durationMinutes * 60000);
    document.getElementById('maintenanceModalTitle').textContent = 'Schedule Maintenance from Template';
    document.getElementById('maintTitle').value = template.title || '';
    document.getElementById('maintMessage').value = template.message || '';
    document.getElementById('maintStart').value = toLocalInput(start.toISOString());
    document.getElementById('maintEnd').value = toLocalInput(end.toISOString());
    renderComponentChecks('maintComponents', template.affectedComponents || []);
}

function openMaintenanceModal(id) {
    if (!requireEdit()) return;
    const maint = (typeof id === 'number') ? ((window.__maintenanceCache || []).find(m => m.id === id)) : null;
    document.getElementById('maintenanceModalTitle').textContent = maint ? 'Edit Maintenance' : 'Schedule Maintenance';
    document.getElementById('maintTitle').value = maint ? maint.title : '';
    document.getElementById('maintMessage').value = maint ? (maint.message || '') : '';
    document.getElementById('maintStart').value = maint ? toLocalInput(maint.scheduledStart) : '';
    document.getElementById('maintEnd').value = maint ? toLocalInput(maint.scheduledEnd) : '';
    document.getElementById('maintId').value = maint ? maint.id : '';
    clearFieldErrors({ title: 'maintTitle', scheduledStart: 'maintStart', scheduledEnd: 'maintEnd' });
    renderComponentChecks('maintComponents', maint ? (maint.affectedComponents || []) : []);
    openModal('maintenanceModal');
}

async function saveMaintenance() {
    if (!requireEdit()) return;
    const id = document.getElementById('maintId').value;
    const form = document.getElementById('maintenanceForm');
    const titleEl = document.getElementById('maintTitle');
    const startEl = document.getElementById('maintStart');
    const endEl = document.getElementById('maintEnd');
    clearFieldErrors({ title: 'maintTitle', scheduledStart: 'maintStart', scheduledEnd: 'maintEnd' });

    const title = String(titleEl.value || '').trim();
    const startRaw = String(startEl.value || '').trim();
    const endRaw = String(endEl.value || '').trim();
    if (!title) titleEl.setCustomValidity('Title is required');
    if (!startRaw) startEl.setCustomValidity('Start date/time is required');
    if (!endRaw) endEl.setCustomValidity('End date/time is required');

    let startDate = null;
    let endDate = null;
    if (startRaw) {
        startDate = new Date(startRaw);
        if (Number.isNaN(startDate.getTime())) startEl.setCustomValidity('Start date/time is invalid');
    }
    if (endRaw) {
        endDate = new Date(endRaw);
        if (Number.isNaN(endDate.getTime())) endEl.setCustomValidity('End date/time is invalid');
    }
    if (startDate && endDate && endDate.getTime() <= startDate.getTime()) {
        endEl.setCustomValidity('End must be after start');
    }
    if (!form.checkValidity()) {
        form.reportValidity();
        const required = [];
        if (!title) required.push('Title');
        if (!startRaw) required.push('Start');
        if (!endRaw) required.push('End');
        toast(required.length ? ('Required fields: ' + required.join(', ')) : 'Please fix invalid maintenance fields');
        return;
    }

    const data = {
        title,
        message: document.getElementById('maintMessage').value,
        scheduledStart: startDate.toISOString(),
        scheduledEnd: endDate.toISOString(),
        affectedComponents: [...document.querySelectorAll('#maintComponents input:checked')].map(i => parseInt(i.value))
    };
    try {
        const result = id
            ? await api('PUT', projectPath('/maintenances/' + id), data)
            : await api('POST', projectPath('/maintenances'), data);
        if (result && result.error) {
            const mapped = applyFieldErrors(result.fieldErrors, { title: 'maintTitle', scheduledStart: 'maintStart', scheduledEnd: 'maintEnd' });
            toast(mapped ? (summarizeFieldErrors(result.fieldErrors) || 'Please complete required fields') : result.error);
            return;
        }
        closeModal('maintenanceModal');
        toast(id ? 'Maintenance updated' : 'Maintenance scheduled');
        loadMaintenances();
    } catch (err) {
        toast(err && err.message ? err.message : 'Failed to save maintenance');
    }
}

function toLocalInput(value) {
    if (!value) return '';
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return '';
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

async function startMaintenance(id) { if (!requireEdit()) return; await api('PUT', projectPath('/maintenances/' + id), { status: 'in_progress' }); toast('Maintenance started'); loadMaintenances(); }
async function completeMaintenance(id) { if (!requireEdit()) return; await api('PUT', projectPath('/maintenances/' + id), { status: 'completed' }); toast('Maintenance completed'); loadMaintenances(); }
async function deleteMaintenance(id) { if (!requireEdit()) return; if (!confirm('Delete?')) return; await api('DELETE', projectPath('/maintenances/' + id)); toast('Deleted'); loadMaintenances(); }

// ── Subscribers ───────────────────────────────────────────────────────────
let selectedSubscriberImportFile = null;

function isValidEmailInput(value) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(value || '').trim());
}

function normalizeEmailInput(value) {
    return String(value || '').trim().toLowerCase();
}

function downloadTextFile(filename, content, mimeType) {
    const blob = new Blob([String(content || '')], { type: mimeType || 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || 'download.txt';
    document.body.appendChild(link);
    link.click();
    link.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function openExportSubscribersModal() {
    openModal('exportSubscribersModal');
}

function openImportSubscribersModal() {
    selectedSubscriberImportFile = null;
    const nameEl = document.getElementById('subscriberImportFileName');
    if (nameEl) nameEl.textContent = 'No file selected.';
    const replaceEl = document.getElementById('subscriberImportReplace');
    if (replaceEl) replaceEl.checked = false;
    const input = document.getElementById('subscriberImportFileInput');
    if (input) input.value = '';
    openModal('importSubscribersModal');
}

function triggerSubscriberImportFile() {
    const input = document.getElementById('subscriberImportFileInput');
    if (input) input.click();
}

function parseSubscriberEmailsFromCsv(text) {
    const lines = String(text || '').split(/\r?\n/);
    const emails = [];
    lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (index === 0 && /^email(\s*,.*)?$/i.test(trimmed)) return;
        const firstCol = trimmed.split(',')[0].replace(/^"|"$/g, '').trim();
        if (!firstCol) return;
        emails.push(firstCol);
    });
    return emails;
}

function parseSubscriberEmailsFromJson(text) {
    const payload = JSON.parse(String(text || '[]'));
    if (!Array.isArray(payload)) throw new Error('JSON must be an array');
    return payload.map((item) => {
        if (typeof item === 'string') return item;
        if (item && typeof item === 'object' && item.email) return String(item.email);
        return '';
    }).filter(Boolean);
}

async function exportSubscribers() {
    const selected = document.querySelector('input[name="subscriberExportFormat"]:checked');
    const format = selected ? String(selected.value || 'csv').toLowerCase() : 'csv';
    const result = await api('GET', projectPath('/subscribers/export?format=' + encodeURIComponent(format)));
    if (result && result.error) {
        toast(result.error);
        return;
    }
    const filename = result.filename || `subscribers.${format}`;
    const content = result.content || '';
    const mimeType = format === 'json' ? 'application/json;charset=utf-8' : 'text/csv;charset=utf-8';
    downloadTextFile(filename, content, mimeType);
    toast(`Exported ${result.count || 0} email subscribers`);
    closeModal('exportSubscribersModal');
}

async function importSubscribers() {
    if (!requireEdit()) return;
    if (!selectedSubscriberImportFile) {
        toast('Choose a CSV or JSON file first');
        return;
    }
    let raw = '';
    try {
        raw = await selectedSubscriberImportFile.text();
    } catch {
        toast('Unable to read selected file');
        return;
    }
    const filename = String(selectedSubscriberImportFile.name || '').toLowerCase();
    let parsed = [];
    try {
        if (filename.endsWith('.json')) parsed = parseSubscriberEmailsFromJson(raw);
        else parsed = parseSubscriberEmailsFromCsv(raw);
    } catch (err) {
        toast(err && err.message ? err.message : 'Invalid import file');
        return;
    }
    const normalized = [...new Set(parsed.map(normalizeEmailInput).filter(Boolean))];
    if (!normalized.length) {
        toast('No email addresses found in file');
        return;
    }
    const replaceExisting = !!document.getElementById('subscriberImportReplace').checked;
    const result = await api('POST', projectPath('/subscribers/import'), {
        emails: normalized,
        replaceExisting
    });
    if (result && result.error) {
        toast(result.error);
        return;
    }
    toast(`Imported ${result.imported || 0}. Skipped existing ${result.skippedExisting || 0}, invalid ${result.skippedInvalid || 0}`);
    closeModal('importSubscribersModal');
    loadSubscribers();
}

async function loadSubscribers() {
    const list = await api('GET', projectPath('/subscribers'));
    const container = document.getElementById('subscribersList');
    const emailSubscribers = Array.isArray(list)
        ? list.filter((s) => isValidEmailInput(s && s.email ? s.email : '')).map((s) => ({ ...s, email: normalizeEmailInput(s.email) }))
        : [];
    if (emailSubscribers.length === 0) { container.innerHTML = '<div class="empty"><div class="empty-icon">&#9993;</div><p>No email subscribers yet</p></div>'; return; }
    container.innerHTML = `<div class="card"><div class="card-body"><div class="table-wrap"><table class="table"><thead><tr><th>Email</th><th>Subscribed</th><th style="text-align:right">Actions</th></tr></thead><tbody>${emailSubscribers.map(s =>
        `<tr><td>${esc(s.email || '-')}</td><td style="color:#7a869a">${new Date(s.createdAt).toLocaleDateString()}</td><td class="actions"><button class="btn btn-sm btn-danger" onclick="deleteSubscriber(${s.id})">Remove</button></td></tr>`
    ).join('')}</tbody></table></div></div></div>`;
}

async function deleteSubscriber(id) { if (!requireEdit()) return; await api('DELETE', projectPath('/subscribers/' + id)); toast('Subscriber removed'); loadSubscribers(); }

// ── Users ─────────────────────────────────────────────────────────────────
let usersCache = [];
async function loadUsers() {
    const res = await api('GET', '/api/v1/admin/users');
    usersCache = Array.isArray(res) ? res : (res && res.users ? res.users : []);
    renderUsersList();
}

function renderUsersList() {
    const container = document.getElementById('usersList');
    if (!usersCache.length) {
        container.innerHTML = '<div class="empty"><div class="empty-icon">&#128101;</div><p>No users yet</p></div>';
        return;
    }
    container.innerHTML = `<div class="card"><div class="card-body"><div class="table-wrap"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th style="text-align:right">Actions</th></tr></thead><tbody>
        ${usersCache.map(u => `
            <tr>
                <td>${esc(u.name || '')}</td>
                <td>${esc(u.email || u.username)}</td>
                <td>${esc(u.role || 'admin')}</td>
                <td style="color:#7a869a">${new Date(u.createdAt).toLocaleDateString()}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-secondary" onclick="openUserModal(${u.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
                </td>
            </tr>
        `).join('')}
    </tbody></table></div></div></div>`;
}

function openUserModal(id) {
    if (!isAdmin()) { toast('Admin only'); return; }
    const user = usersCache.find(u => u.id === id);
    document.getElementById('userModalTitle').textContent = user ? 'Edit User' : 'New User';
    document.getElementById('userNameInput').value = user ? (user.name || '') : '';
    document.getElementById('userEmail').value = user ? (user.email || user.username || '') : '';
    document.getElementById('userPassword').value = '';
    document.getElementById('userRole').value = user ? (user.role || 'admin') : 'admin';
    document.getElementById('userId').value = user ? user.id : '';
    openModal('userModal');
}

async function saveUser() {
    if (!isAdmin()) { toast('Admin only'); return; }
    const id = document.getElementById('userId').value;
    const data = {
        name: document.getElementById('userNameInput').value,
        email: document.getElementById('userEmail').value.trim(),
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRole').value
    };
    if (!data.email) return;
    if (!id && !data.password) { toast('Password required for new user'); return; }
    if (!data.password) delete data.password;
    let result;
    if (id) result = await api('PUT', '/api/v1/admin/users/' + id, data);
    else result = await api('POST', '/api/v1/admin/users', data);
    if (!result || result.error || !result.id) {
        toast(result && result.error ? result.error : 'User was not created');
        await loadUsers();
        return;
    }
    closeModal('userModal');
    toast(id ? 'User updated' : 'User created');
    if (result && result.id) {
        if (id) {
            const idx = usersCache.findIndex(u => u.id === result.id);
            if (idx >= 0) usersCache[idx] = result;
        } else {
            usersCache.push(result);
        }
        renderUsersList();
    } else {
        loadUsers();
    }
}

async function deleteUser(id) {
    if (!isAdmin()) { toast('Admin only'); return; }
    if (!confirm('Delete this user?')) return;
    await api('DELETE', '/api/v1/admin/users/' + id);
    toast('User deleted');
    loadUsers();
}

// ── Settings ──────────────────────────────────────────────────────────────
let disabledTabs = {};
let activeSettingsSubtab = 'page-info';

function showSettingsSubtab(name) {
    if (!isAdmin() && name === 'admin-panel') name = 'page-info';
    activeSettingsSubtab = name;
    document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById('settingsTabBtn-' + name);
    if (activeBtn) activeBtn.classList.add('active');
    document.querySelectorAll('.settings-subpage').forEach(p => p.classList.remove('active'));
    const activePage = document.getElementById('settings-subtab-' + name);
    if (activePage) activePage.classList.add('active');
    if (name === 'analytics') loadAnalyticsData();
    if (name === 'activity-log') loadActivityLog();
}

async function loadDomainConfig() {
    const cfg = await api('GET', projectPath('/domain-config'));
    if (cfg && cfg.error) return;
    const targetInput = document.getElementById('dnsExpectedTarget');
    if (targetInput) targetInput.value = cfg.expectedTarget || '';
    const primaryInfo = document.getElementById('dnsInstructionPrimary');
    if (primaryInfo) primaryInfo.textContent = (cfg.instructions && cfg.instructions.primary) || '';
    const redirectInfo = document.getElementById('dnsInstructionRedirect');
    if (redirectInfo) redirectInfo.textContent = (cfg.instructions && cfg.instructions.redirect) || '';
    const provisionPanel = document.getElementById('domainProvisionResults');
    if (provisionPanel && cfg && cfg.provisioning && cfg.provisioning.enabled === false) {
        provisionPanel.innerHTML = `<div style="color:#b38600">Domain automation is not configured on server. Set FIREBASE_PROJECT_ID/FIREBASE_HOSTING_SITE for provisioning.</div>`;
    }
}

async function validateProjectDomains() {
    const panel = document.getElementById('dnsValidationResults');
    if (panel) panel.textContent = 'Validating DNS records...';
    const result = await api('POST', projectPath('/domain-validate'), {});
    renderDomainValidation(result);
}

function renderEmailServiceStatus(status) {
    const panel = document.getElementById('emailServiceStatus');
    if (!panel) return;
    if (!status || status.error) {
        panel.innerHTML = `<div style="color:#bf2600">${esc((status && status.error) || 'Unable to load email status')}</div>`;
        return;
    }
    const enabled = !!status.enabled;
    const color = enabled ? '#0b875b' : '#b38600';
    const missing = Array.isArray(status.missingConfig) ? status.missingConfig : [];
    const missingText = missing.length ? missing.join(', ') : 'None';
    const sender = status.sender || {};
    const smtp = status.smtp || {};
    panel.innerHTML = `
        <div><strong>Provider:</strong> ${esc(status.provider || '-')}</div>
        <div><strong>Status:</strong> <span style="color:${color};font-weight:600">${enabled ? 'READY' : 'NOT CONFIGURED'}</span></div>
        <div><strong>SMTP:</strong> host=${esc(smtp.host || '-')} port=${esc(String(smtp.port || '-'))} secure=${smtp.secure ? 'yes' : 'no'} auth=${smtp.hasAuth ? 'yes' : 'no'}</div>
        <div><strong>Sender:</strong> ${esc(sender.fromEmail || '-')} (reply-to: ${esc(sender.replyTo || '-')})</div>
        <div><strong>Missing:</strong> ${esc(missingText)}</div>
    `;
}

async function loadEmailServiceStatus() {
    const panel = document.getElementById('emailServiceStatus');
    if (panel) panel.textContent = 'Checking email delivery configuration...';
    const status = await api('GET', projectPath('/email-status'));
    renderEmailServiceStatus(status);
}

async function sendTestEmail() {
    if (!requireEdit()) return;
    const to = String(document.getElementById('emailTestRecipient').value || '').trim();
    const subject = String(document.getElementById('emailTestSubject').value || '').trim();
    const message = String(document.getElementById('emailTestMessage').value || '').trim();
    const payload = {};
    if (to) payload.email = to;
    if (subject) payload.subject = subject;
    if (message) payload.message = message;
    const result = await api('POST', projectPath('/email-test'), payload);
    if (result && result.error) {
        toast(result.error);
        if (Array.isArray(result.missingConfig) && result.missingConfig.length) {
            toast('Missing: ' + result.missingConfig.join(', '));
        }
        await loadEmailServiceStatus();
        return;
    }
    toast('Test email sent to ' + (result.to || to));
    await loadEmailServiceStatus();
}

function renderAnalytics(data) {
    const cards = document.getElementById('analyticsCards');
    const table = document.getElementById('analyticsDailyTable');
    if (!cards || !table) return;
    if (!data || data.error) {
        cards.innerHTML = '<div class="analytics-card"><div class="label">Error</div><div class="value">-</div></div>';
        table.innerHTML = `<div class="empty">Unable to load analytics.</div>`;
        return;
    }
    cards.innerHTML = `
        <div class="analytics-card"><div class="label">Total Views (${data.windowDays}d)</div><div class="value">${data.totalViews || 0}</div></div>
        <div class="analytics-card"><div class="label">Unique Visitors (${data.windowDays}d)</div><div class="value">${data.totalUniqueVisitors || 0}</div></div>
        <div class="analytics-card"><div class="label">Subscribers</div><div class="value">${data.subscribers || 0}</div></div>
        <div class="analytics-card"><div class="label">Incidents (30d)</div><div class="value">${data.recentIncidents || 0}</div></div>
    `;
    const rows = (data.daily || []).map(d =>
        `<tr><td>${esc(d.date)}</td><td>${d.views || 0}</td><td>${d.uniqueVisitors || 0}</td></tr>`
    ).join('');
    table.innerHTML = `
        <div class="table-wrap">
            <table class="daily-analytics-table">
                <thead><tr><th>Date</th><th>Views</th><th>Unique Visitors</th></tr></thead>
                <tbody>${rows || '<tr><td colspan="3">No analytics data yet.</td></tr>'}</tbody>
            </table>
        </div>
    `;
}

async function loadAnalyticsData() {
    const data = await api('GET', projectPath('/analytics?days=30'));
    renderAnalytics(data);
}

function renderActivityLog(payload) {
    const container = document.getElementById('activityLogList');
    if (!container) return;
    const items = payload && payload.items ? payload.items : [];
    if (!items.length) {
        container.innerHTML = `<div class="activity-item"><div class="activity-summary">No recent changes.</div><div class="activity-meta">Actions by admins/editors for this project will appear here.</div></div>`;
        return;
    }
    container.innerHTML = items.map((item) => {
        const user = item.user && item.user.username ? item.user.username : 'system';
        const at = item.at ? new Date(item.at).toLocaleString() : '';
        return `<div class="activity-item">
            <div class="activity-summary">${esc(item.summary || item.action || 'Change')}</div>
            <div class="activity-meta">${esc(user)} • ${esc(at)}</div>
        </div>`;
    }).join('');
}

async function loadActivityLog() {
    const payload = await api('GET', projectPath('/activity?limit=50'));
    renderActivityLog(payload);
}

async function loadSettings() {
    const s = await api('GET', projectPath('/settings'));
    initEmailLogoUpload();
    initBrandLogoUpload();
    document.getElementById('setOrganizationLegalName').value = s.organizationLegalName || s.companyName || '';
    document.getElementById('setPageName').value = s.pageName || s.pageTitle || '';
    document.getElementById('setPageTitle').value = s.pageTitle || '';
    document.getElementById('setCompanyUrl').value = s.companyUrl || '';
    document.getElementById('setSupportUrl').value = s.supportUrl || '';
    document.getElementById('setPrivacyPolicyUrl').value = s.privacyPolicyUrl || '';
    dualDisplayMode = s.displayMode === 'triad' ? 'triad' : (s.displayMode === 'dual' ? 'dual' : 'single');
    dualSecondaryProjectId = (dualDisplayMode === 'dual' || dualDisplayMode === 'triad') ? (parseInt(s.secondaryProjectId, 10) || null) : null;
    dualTertiaryProjectId = dualDisplayMode === 'triad' ? (parseInt(s.tertiaryProjectId, 10) || null) : null;
    onDisplayModeChange(dualDisplayMode);
    projectViewConfig.mode = dualDisplayMode;
    projectViewConfig.primaryProjectId = currentProjectId;
    projectViewConfig.secondaryProjectId = dualSecondaryProjectId;
    projectViewConfig.tertiaryProjectId = dualTertiaryProjectId;
    renderProjectViewModeControls();
    document.getElementById('setSmsCountryCode').value = s.defaultSmsCountryCode || '+1';
    document.getElementById('setCustomDomain').value = s.customDomain || '';
    document.getElementById('setRedirectDomains').value = Array.isArray(s.redirectDomains) ? s.redirectDomains.join('\n') : '';
    document.getElementById('setDomainAutomationProvider').value = s.domainAutomationProvider || 'firebase_hosting';
    document.getElementById('setDomainRegistrar').value = s.domainRegistrar || '';
    document.getElementById('setDnsProvider').value = s.dnsProvider || '';
    document.getElementById('setDomainContactEmail').value = s.domainContactEmail || '';
    document.getElementById('setDnsProviderAccountId').value = s.dnsProviderAccountId || '';
    document.getElementById('setDnsProviderZone').value = s.dnsProviderZone || '';
    document.getElementById('setGaTrackingId').value = s.googleAnalyticsTrackingId || '';
    document.getElementById('setSupportEmail').value = s.supportEmail || '';
    document.getElementById('setNotificationFromName').value = s.notificationFromName || s.organizationLegalName || '';
    document.getElementById('setNotificationFromEmail').value = s.notificationFromEmail || '';
    document.getElementById('setNotificationReplyToEmail').value = s.notificationReplyToEmail || '';
    document.getElementById('setNotificationFooterMessage').value = s.notificationFooterMessage || '';
    document.getElementById('setNotificationLogoUrl').value = s.notificationLogoUrl || '';
    document.getElementById('setNotificationUseStatusLogo').checked = s.notificationUseStatusLogo !== false;
    document.getElementById('setStatusPageLogoUrl').value = s.statusPageLogoUrl || DEFAULT_BRAND_LOGO_URL;
    document.getElementById('setAdminPanelLogoUrl').value = s.adminPanelLogoUrl || DEFAULT_BRAND_LOGO_URL;
    document.getElementById('setEffectiveNotificationFromEmail').value = s.effectiveNotificationFromEmail || s.notificationFromEmail || s.supportEmail || '';
    document.getElementById('emailTestRecipient').value = s.supportEmail || s.notificationReplyToEmail || '';
    document.getElementById('emailTestSubject').value = '';
    document.getElementById('emailTestMessage').value = '';
    renderEmailLogoPreview();
    renderStatusLogoPreview();
    renderAdminPanelLogoPreview();
    document.getElementById('setBrandColor').value = s.brandColor || '#8738ff';
    document.getElementById('setAboutText').value = s.aboutText || '';
    document.getElementById('setTimezone').value = s.timezone || 'UTC';
    document.getElementById('setHideFromSearchEngines').checked = !!s.hideFromSearchEngines;
    currentProjectCustomDomain = normalizeDomainInput(s.customDomain || '');
    updateViewLink();
    updatePublishUrlPreview();
    await loadDomainConfig();
    await loadDomainProvisionStatus();
    await loadEmailServiceStatus();
    const viewSelect = document.getElementById('componentsView');
    if (viewSelect) viewSelect.value = s.componentsView || 'list';
    componentsDisplayMode = s.componentsView || 'list';
    const uptimeSelect = document.getElementById('showUptime');
    if (uptimeSelect) uptimeSelect.value = String(s.showUptime !== false);
    renderDualProjectSelectors();
    disabledTabs = s.disabledTabs || {};
    applyMenuVisibility();
    showSettingsSubtab(activeSettingsSubtab);
}

document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!requireEdit()) return;
    clearFieldErrors({
        domainRegistrar: 'setDomainRegistrar',
        dnsProvider: 'setDnsProvider',
        domainContactEmail: 'setDomainContactEmail'
    });
    const saved = await api('PUT', projectPath('/settings'), {
        organizationLegalName: document.getElementById('setOrganizationLegalName').value,
        companyName: document.getElementById('setOrganizationLegalName').value,
        pageName: document.getElementById('setPageName').value,
        pageTitle: document.getElementById('setPageTitle').value,
        companyUrl: document.getElementById('setCompanyUrl').value,
        supportUrl: document.getElementById('setSupportUrl').value,
        privacyPolicyUrl: document.getElementById('setPrivacyPolicyUrl').value,
        defaultSmsCountryCode: document.getElementById('setSmsCountryCode').value,
        notificationFromName: document.getElementById('setNotificationFromName').value,
        notificationFromEmail: document.getElementById('setNotificationFromEmail').value,
        notificationReplyToEmail: document.getElementById('setNotificationReplyToEmail').value,
        notificationFooterMessage: document.getElementById('setNotificationFooterMessage').value,
        notificationLogoUrl: document.getElementById('setNotificationLogoUrl').value,
        notificationUseStatusLogo: document.getElementById('setNotificationUseStatusLogo').checked,
        statusPageLogoUrl: document.getElementById('setStatusPageLogoUrl').value,
        adminPanelLogoUrl: document.getElementById('setAdminPanelLogoUrl').value,
        customDomain: normalizeDomainInput(document.getElementById('setCustomDomain').value),
        redirectDomains: parseRedirectDomainsInput(document.getElementById('setRedirectDomains').value),
        domainAutomationProvider: document.getElementById('setDomainAutomationProvider').value,
        domainRegistrar: document.getElementById('setDomainRegistrar').value,
        dnsProvider: document.getElementById('setDnsProvider').value,
        domainContactEmail: document.getElementById('setDomainContactEmail').value,
        dnsProviderAccountId: document.getElementById('setDnsProviderAccountId').value,
        dnsProviderZone: document.getElementById('setDnsProviderZone').value,
        googleAnalyticsTrackingId: document.getElementById('setGaTrackingId').value,
        hideFromSearchEngines: document.getElementById('setHideFromSearchEngines').checked,
        supportEmail: document.getElementById('setSupportEmail').value,
        brandColor: document.getElementById('setBrandColor').value,
        aboutText: document.getElementById('setAboutText').value,
        timezone: document.getElementById('setTimezone').value
    });
    if (saved && saved.error) {
        applyFieldErrors(saved.fieldErrors, {
            domainRegistrar: 'setDomainRegistrar',
            dnsProvider: 'setDnsProvider',
            domainContactEmail: 'setDomainContactEmail'
        });
        toast(saved.error);
        return;
    }
    currentProjectCustomDomain = normalizeDomainInput(saved && saved.customDomain ? saved.customDomain : '');
    await loadProjectsList();
    toast('Settings saved');
    await loadSettings();
    showSettingsSubtab(activeSettingsSubtab);
});

const customDomainField = document.getElementById('setCustomDomain');
if (customDomainField) customDomainField.addEventListener('input', updatePublishUrlPreview);
const subscriberImportFileInput = document.getElementById('subscriberImportFileInput');
if (subscriberImportFileInput) {
    subscriberImportFileInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0] ? e.target.files[0] : null;
        selectedSubscriberImportFile = file;
        const nameEl = document.getElementById('subscriberImportFileName');
        if (nameEl) nameEl.textContent = file ? file.name : 'No file selected.';
    });
}
const useStatusLogoCheckbox = document.getElementById('setNotificationUseStatusLogo');
if (useStatusLogoCheckbox) {
    useStatusLogoCheckbox.addEventListener('change', (e) => {
        if (e.target.checked && !(document.getElementById('setNotificationLogoUrl').value || '').trim()) {
            copyLogoFromStatusPage();
        }
    });
}

async function saveShowUptime() {
    if (!requireEdit()) return;
    const val = document.getElementById('showUptime').value === 'true';
    await api('PUT', componentProjectPath('/settings'), { showUptime: val });
    toast('Uptime section updated for ' + componentScopeLabel(activeComponentProjectId || currentProjectId));
}

function applyMenuVisibility() {
    const map = disabledTabs || {};
    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
        const tab = item.getAttribute('data-tab');
        const hidden = isTabHiddenForCurrentUser(tab);
        item.style.display = hidden ? 'none' : '';
        const tabPage = document.getElementById('tab-' + tab);
        if (tabPage) tabPage.style.display = hidden ? 'none' : '';
    });
    document.getElementById('toggle-components').checked = !!map.components;
    document.getElementById('toggle-incidents').checked = !!map.incidents;
    document.getElementById('toggle-maintenance').checked = !!map.maintenance;
    document.getElementById('toggle-subscribers').checked = !!map.subscribers;
    document.getElementById('toggle-projects').checked = !!map.projects;
    document.getElementById('toggle-users').checked = !!map.users;
    document.getElementById('toggle-settings').checked = !!map.settings;
    const activeTab = document.querySelector('.tab-page.active');
    if (activeTab && activeTab.style.display === 'none') showTab('dashboard');
}

async function saveMenuVisibility() {
    if (!isAdmin()) { toast('Admin only'); return; }
    if (!requireEdit()) return;
    disabledTabs = {
        components: document.getElementById('toggle-components').checked,
        incidents: document.getElementById('toggle-incidents').checked,
        maintenance: document.getElementById('toggle-maintenance').checked,
        subscribers: document.getElementById('toggle-subscribers').checked,
        projects: document.getElementById('toggle-projects').checked,
        users: document.getElementById('toggle-users').checked,
        settings: document.getElementById('toggle-settings').checked
    };
    await api('PUT', projectPath('/settings'), { disabledTabs });
    toast('Menu visibility saved');
    applyMenuVisibility();
}

function applyRolePermissions() {
    const usersNav = document.querySelector('.nav-item[data-tab="users"]');
    if (usersNav) usersNav.style.display = isTabHiddenForCurrentUser('users') ? 'none' : '';
    const usersTab = document.getElementById('tab-users');
    if (usersTab) usersTab.style.display = isTabHiddenForCurrentUser('users') ? 'none' : '';
    const adminPanelSettingsBtn = document.getElementById('settingsTabBtn-admin-panel');
    if (adminPanelSettingsBtn) adminPanelSettingsBtn.style.display = isAdmin() ? '' : 'none';
    const adminPanelSettingsTab = document.getElementById('settings-subtab-admin-panel');
    if (adminPanelSettingsTab) adminPanelSettingsTab.style.display = isAdmin() ? '' : 'none';
    if (!isAdmin() && activeSettingsSubtab === 'admin-panel') showSettingsSubtab('page-info');

    const editOnlyButtons = [
        'qaIncidentBtn', 'qaMaintenanceBtn', 'qaComponentBtn',
        'componentsAddBtn', 'incidentsAddBtn', 'maintenanceAddBtn', 'projectsAddBtn', 'projectViewSaveBtn',
        'incidentTemplateAddBtn', 'maintenanceTemplateAddBtn', 'settingsSaveBtn', 'menuSaveBtn', 'subscribersImportBtn', 'subscribersExportBtn',
        'statusLogoUploadBtn', 'statusLogoCopyFromAdminBtn', 'statusLogoResetBtn',
        'adminLogoUploadBtn', 'adminLogoCopyFromStatusBtn', 'adminLogoResetBtn'
    ];
    editOnlyButtons.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = canEdit() ? '' : 'none';
    });
    ['projectViewModeSelect', 'projectPrimarySelect', 'projectSecondarySelect', 'projectTertiarySelect'].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = !canEdit();
    });
    ['statusLogoDrop', 'adminPanelLogoDrop', 'emailLogoDrop'].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.pointerEvents = canEdit() ? '' : 'none';
        el.style.opacity = canEdit() ? '1' : '.6';
    });
}

// ── Utils ─────────────────────────────────────────────────────────────────
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function statusLabel(s) {
    const m = { operational: 'Operational', degraded_performance: 'Degraded', partial_outage: 'Partial Outage', major_outage: 'Major Outage', under_maintenance: 'Maintenance', investigating: 'Investigating', identified: 'Identified', monitoring: 'Monitoring', resolved: 'Resolved', scheduled: 'Scheduled', in_progress: 'In Progress', completed: 'Completed', none: 'None', minor: 'Minor', major: 'Major', critical: 'Critical' };
    return m[s] || s;
}

// ── Init ──────────────────────────────────────────────────────────────────
async function init() {
    let user = {};
    try {
        const me = await fetch('/api/v1/auth/me', { credentials: 'same-origin' });
        if (!me.ok) {
            window.location.href = '/login.html';
            return;
        }
        user = await me.json();
        localStorage.setItem('statusPageUser', JSON.stringify(user));
    } catch {
        window.location.href = '/login.html';
        return;
    }
    if (user.username) {
        document.getElementById('userName').textContent = user.username;
        document.getElementById('userInitials').textContent = user.username.slice(0, 2).toUpperCase();
    }
    currentUserRole = user.role || 'viewer';
    applyRolePermissions();
    await loadProjectsList();
    if (currentProjectId) await setCurrentProject(currentProjectId);
}
init();
</script>
</body>
</html>
